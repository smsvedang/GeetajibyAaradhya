<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Gitadhya - Spiritual Wisdom</title>
  <link rel="stylesheet" href="style.css">
</head>

<body>

  <nav class="top-navbar">
    <div class="container nav-container">
      <div class="logo">
        <a href="index.html">Gitadhya</a>
      </div>
      <div class="menu-links" id="nav-links">
        <a href="index.html" class="main-tab-button">Home</a>
        <a href="courses.html" class="main-tab-button">Courses</a>
        <a href="artwork.html" class="main-tab-button">Art</a>
        <a href="blog.html" class="main-tab-button">Blog</a>
        <a href="testimonials.html" class="main-tab-button">Testimonials</a>
      </div>
      <button class="menu-toggle" id="menu-btn"><i class="fas fa-bars"></i></button>
    </div>
  </nav>

  <div class="container">
    <main id="single-shloka-container">
      <p>Loading shloka...</p>
    </main>
  </div>

  <footer class="main-footer">
    <div class="container">
      <h2 id="footer-logo-text">Gitadhya</h2>
      <div class="social-row" id="social-links"></div>
      <p style="opacity: 0.6; font-size: 0.9rem;">&copy; 2026 Gitadhya | Spiritual Resonance</p>
    </div>
  </footer>

  <script>
    let ytApiReady = false;
    let pendingPlayers = [];

    const gitadhyaUser = JSON.parse(localStorage.getItem('gitadhya_user'));
    const userMobile = gitadhyaUser ? gitadhyaUser.mobile : '';

    function createPendingPlayers() {
      if (!ytApiReady) return;

      pendingPlayers.forEach(p => {
        if (p._created) return; // duplicate se bachao
        p._created = true;

        new YT.Player(p.elementId, {
          videoId: p.videoId,
          playerVars: {
            enablejsapi: 1,
            origin: window.location.origin
          },
          events: {
            onStateChange: (e) => {
              if (e.data === YT.PlayerState.ENDED) {
                const courseId = localStorage.getItem('active_course');
                if (!courseId || !userMobile) return;

                fetch('/api/progress/save', {
                  method: 'POST',
                  headers: { 'Content-Type': 'application/json' },
                  body: JSON.stringify({
                    mobile: userMobile,
                    courseId,
                    completed: [p.shlokaId]
                  })
                });

                console.log('‚úÖ COMPLETED (ENDED)', p.shlokaId);
              }
            }
          }
        });
      });
    }

    function createSingleShlokaCard(shloka) {
      const item = document.createElement('div');
      item.className = 'shloka-item-card';

      const formattedText = shloka.text ? shloka.text.replace(/\n/g, '<br>') : '';
      const isLiked = localStorage.getItem('liked_' + shloka._id) === 'true';
      const shareTitle = `Aaradhya Soni - Gita Adhyay ${shloka.adhyay}, Shloka ${shloka.shloka}`;
      const shareText = `Listen to Aaradhya's recitation of Gita Adhyay ${shloka.adhyay}, Shloka ${shloka.shloka}`;
      const shareUrl = window.location.href;

      item.innerHTML = `
  <div class="card-video-container">
    <div id="yt-single-${shloka._id}"></div>
  </div>

  <div class="card-content">
    <h3>Adhyay ${shloka.adhyay}, Shloka ${shloka.shloka}</h3>
    <p class="shloka-text">${formattedText}</p>

    <div class="shloka-actions">
      <button class="shloka-action-button like-button"
              data-id="${shloka._id}"
              ${isLiked ? 'disabled' : ''}>
        ‚ù§Ô∏è <span class="like-count">${shloka.likes || 0}</span>
      </button>

      <button class="shloka-action-button share-button"
              data-url="${shareUrl}"
              data-title="${shareTitle}"
              data-text="${shareText}">
        üîó Share
      </button>
    </div>
  </div>
`;
      return item;
    }

    // Page load hone par shlok fetch karo (UPDATED - Reverted to ID)
    document.addEventListener('DOMContentLoaded', async () => {
      const container = document.getElementById('single-shloka-container');

      // 1. URL se ID nikalo (e.g., ?id=12345)
      const params = new URLSearchParams(window.location.search);
      const shlokaId = params.get('id'); // 'id' se fetch karein

      if (!shlokaId) {
        container.innerHTML = "<p>Error: No shloka ID provided.</p>";
        return;
      }

      // 2. Puraane API route se data fetch karo
      try {
        // [FIX] Cache buster add kiya gaya
        const cacheBuster = `?cache_buster=${new Date().getTime()}`;
        const response = await fetch(`/api/shloka/${shlokaId}${cacheBuster}`);

        if (!response.ok) {
          const errorData = await response.json();
          throw new Error(errorData.message || 'Shloka not found');
        }

        const shloka = await response.json();

        // Load site info for social links
        try {
          const sr = await fetch('/api/settings');
          const settings = await sr.json();
          const socBox = document.getElementById('social-links');
          if (socBox) {
            socBox.innerHTML = '';
            const icons = { instagram: 'fab fa-instagram', youtube: 'fab fa-youtube', twitter: 'fab fa-twitter', facebook: 'fab fa-facebook' };
            if (settings.personalLink) {
              if (settings.personalLinkLogo) {
                socBox.innerHTML += `<a href="${settings.personalLink}" target="_blank" class="social-icon"><img src="${settings.personalLinkLogo}" style="height:24px; width:24px; border-radius:50%; vertical-align:middle;"></a>`;
              } else {
                socBox.innerHTML += `<a href="${settings.personalLink}" target="_blank" class="social-icon"><i class="fas fa-globe"></i></a>`;
              }
            }
            if (settings.social) {
              Object.keys(settings.social).forEach(key => {
                const url = settings.social[key];
                if (url) socBox.innerHTML += `<a href="${url}" target="_blank" class="social-icon"><i class="${icons[key]}"></i></a>`;
              });
            }
          }
        } catch (e) { console.error("Settings load error", e); }

        container.innerHTML = '';
        const shlokaCard = createSingleShlokaCard(shloka);
        container.appendChild(shlokaCard);

        // --- Mobile Menu ---
        const menuBtn = document.getElementById('menu-btn');
        const navLinks = document.getElementById('nav-links');
        if (menuBtn && navLinks) {
          menuBtn.onclick = () => {
            navLinks.classList.toggle('active');
          };
        }

        pendingPlayers.push({
          elementId: `yt-single-${shloka._id}`,
          videoId: shloka.video_id,
          shlokaId: shloka._id
        });
        createPendingPlayers();

      } catch (err) {
        console.error(err);
        container.innerHTML = `<p>Error: ${err.message}</p>`;
      }
    });

    // 3. Like/Share button logic (No Change)
    document.getElementById('single-shloka-container').addEventListener('click', async (e) => {
      const shareButton = e.target.closest('.share-button');
      if (shareButton) {
        const urlToShare = shareButton.dataset.url;
        const title = shareButton.dataset.title;
        const text = shareButton.dataset.text;
        if (navigator.share) {
          try { await navigator.share({ title: title, text: text, url: urlToShare }); }
          catch (err) { console.error('Share failed:', err); }
        } else {
          try { await navigator.clipboard.writeText(urlToShare); alert('Link copied to clipboard!'); }
          catch (err) { alert('Failed to copy link.'); }
        }
      }
      const likeButton = e.target.closest('.like-button');
      if (likeButton) {
        const shlokaDbId = likeButton.dataset.id;
        if (localStorage.getItem('liked_' + shlokaDbId)) { return; }
        likeButton.disabled = true;
        try {
          const response = await fetch(`/api/shloka/like/${shlokaDbId}`, { method: 'POST' });
          const data = await response.json();
          if (data.success) {
            const countSpan = likeButton.querySelector('.like-count');
            countSpan.textContent = data.likes;
            localStorage.setItem('liked_' + shlokaDbId, 'true');
          } else { likeButton.disabled = false; }
        } catch (err) { likeButton.disabled = false; }
      }
    });
  </script>
  <script src="https://www.youtube.com/iframe_api"></script>
  <script>
    function onYouTubeIframeAPIReady() {
      ytApiReady = true;
      createPendingPlayers();
    }
  </script>
</body>

</html>