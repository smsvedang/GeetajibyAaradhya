<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Gitadhya - Spiritual Wisdom</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;600;700;900&display=swap"
    rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <link rel="stylesheet" href="style.css">
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-messaging-compat.js"></script>
  <link rel="manifest" href="/site.webmanifest">
</head>

<body>

  <div class="auth-overlay" id="auth-overlay">
    <div class="auth-modal" id="login-modal">
      <button class="auth-close" onclick="closeAuth()" aria-label="Close">‚úï</button>
      <h2>Haree Krishna,</h2>
      <form id="student-login-form">
        <input type="tel" id="l-mobile" placeholder="Mobile Number" required>
        <input type="password" id="l-pass" placeholder="Password" required>
        <button type="submit" class="auth-btn">Login to Continue</button>
      </form>
      <div class="auth-switch" onclick="switchAuth('register')">New seeker? Register here</div>
    </div>

    <div class="auth-modal" id="register-modal" style="display:none;">
      <button class="auth-close" onclick="closeAuth()" aria-label="Close">‚úï</button>
      <h2>Join the Journey,</h2>
      <form id="student-register-form">
        <input type="text" id="r-name" placeholder="Your Full Name" required>
        <div style="font-size:0.85rem; color:var(--text-muted); margin:-4px 0 10px;">
          Phone number ‡§µ‡§π‡•Ä ‡§°‡§æ‡§≤‡•á‡§Ç ‡§ú‡§ø‡§∏ ‡§™‡§∞ ‡§Ü‡§™ certificate receive ‡§ï‡§∞‡•á‡§Ç‡§ó‡•á
        </div>
        <input type="tel" id="r-mobile" placeholder="Mobile Number" required>
        <input type="password" id="r-pass" placeholder="Create Password" required>
        <button type="submit" class="auth-btn">Register</button>
      </form>
      <div class="auth-switch" onclick="switchAuth('login')">Already registered? Login here</div>
    </div>
  </div>

  <nav class="top-navbar">
    <div class="container nav-container">
      <div class="logo">
        <a href="index.html">Gitadhya-Gita by Aaradhya</a>
      </div>
      <div class="menu-links" id="nav-links">
        <a href="index.html" class="main-tab-button">Home</a>
        <a href="index.html#site-about-main" class="main-tab-button">About</a>
        <a href="courses.html" class="main-tab-button">Courses</a>
        <a href="artwork.html" class="main-tab-button">Art</a>
        <a href="blog.html" class="main-tab-button">Blog</a>
        <a href="testimonials.html" class="main-tab-button">Testimonials</a>
        <button class="main-tab-button" id="back-btn" onclick="goBack()"
          style="display:none; background:#eee; border-radius: 10px;">
          <i class="fas fa-arrow-left"></i> All Courses
        </button>
        <div id="auth-box">
          <a href="index.html?auth=true" class="main-tab-button">Login</a>
        </div>
      </div>
      <button class="menu-toggle" id="menu-btn"><i class="fas fa-bars"></i></button>
    </div>
  </nav>

  <header class="shloka-welcome-hero" style="padding-top:120px;">
    <div class="container">
      <div class="verified-badge-inline">
        <span class="dot"></span>
        Spiritual Wisdom
      </div>
      <h1>Divine Shloka</h1>
      <p class="subtitle">Listen, reflect, and share the sacred verses.</p>
    </div>
  </header>

  <div class="container" style="padding: 40px 0 80px;">
    <main id="single-shloka-container" style="max-width: 900px; margin: 0 auto;">
      <p style="text-align:center; color:var(--text-muted);">Loading shloka...</p>
    </main>
  </div>

  <footer class="main-footer">
    <div class="container">
      <h2 id="footer-logo-text">Gitadhya</h2>
      <div class="social-row" id="social-links"></div>
      <p style="opacity: 0.6; font-size: 0.9rem;">&copy; 2026 Gitadhya | Spiritual Resonance</p>
    </div>
  </footer>

  <script>
    let ytApiReady = false;
    let pendingPlayers = [];

    let currentUser = JSON.parse(localStorage.getItem('gitadhya_user'));
    const userMobile = currentUser ? currentUser.mobile : '';

    function showAuth() { document.getElementById('auth-overlay').style.display = 'flex'; }
    function closeAuth() { document.getElementById('auth-overlay').style.display = 'none'; }
    function switchAuth(type) {
      document.getElementById('login-modal').style.display = type === 'login' ? 'block' : 'none';
      document.getElementById('register-modal').style.display = type === 'register' ? 'block' : 'none';
    }

    document.getElementById('student-register-form').onsubmit = async (e) => {
      e.preventDefault();
      const res = await fetch('/api/student/register', {
        method: 'POST', headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ name: document.getElementById('r-name').value, mobile: document.getElementById('r-mobile').value, password: document.getElementById('r-pass').value })
      });
      const d = await res.json();
      if (d.success) { localStorage.setItem('gitadhya_user', JSON.stringify(d.student)); location.reload(); }
      else alert(d.message);
    };

    document.getElementById('student-login-form').onsubmit = async (e) => {
      e.preventDefault();
      const res = await fetch('/api/student/login', {
        method: 'POST', headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ mobile: document.getElementById('l-mobile').value, password: document.getElementById('l-pass').value })
      });
      const d = await res.json();
      if (d.success) { localStorage.setItem('gitadhya_user', JSON.stringify(d.student)); location.reload(); }
      else alert(d.message);
    };

    function createPendingPlayers() {
      if (!ytApiReady) return;

      pendingPlayers.forEach(p => {
        if (p._created) return; // duplicate se bachao
        p._created = true;

        try {
          new YT.Player(p.elementId, {
            videoId: p.videoId,
            width: '100%',
            height: '100%',
            playerVars: {
              enablejsapi: 1,
              origin: window.location.origin
            },
            events: {
              onStateChange: (e) => {
                if (e.data === YT.PlayerState.ENDED) {
                  const courseId = localStorage.getItem('active_course');
                  if (!courseId || !userMobile) return;

                  fetch('/api/progress/save', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                      mobile: userMobile,
                      courseId,
                      completed: [p.shlokaId]
                    })
                  });

                  console.log('‚úÖ COMPLETED (ENDED)', p.shlokaId);
                }
              }
            }
          });
        } catch (err) {
          renderIframeFallback(p.elementId, p.videoId);
        }
      });
    }

    function renderIframeFallback(elementId, videoId) {
      const el = document.getElementById(elementId);
      if (!el || !videoId) return;
      el.innerHTML = `
        <iframe src="https://www.youtube.com/embed/${videoId}"
          title="Shloka Video"
          frameborder="0"
          allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture"
          allowfullscreen></iframe>
      `;
    }

    function createSingleShlokaCard(shloka) {
      const item = document.createElement('div');
      item.className = 'shloka-item-card';

      const formattedText = shloka.text ? shloka.text.replace(/\n/g, '<br>') : '';
      const isLiked = localStorage.getItem('liked_' + shloka._id) === 'true';
      const shareTitle = `Aaradhya Soni - Gita Adhyay ${shloka.adhyay}, Shloka ${shloka.shloka}`;
      const shareText = `Listen to Aaradhya's recitation of Gita Adhyay ${shloka.adhyay}, Shloka ${shloka.shloka}`;
      const shareUrl = window.location.href;

      item.innerHTML = `
  <div class="card-video-container">
    <div id="yt-single-${shloka._id}" data-video-id="${shloka.video_id || ''}" style="width:100%; height:100%;"></div>
  </div>

  <div class="card-content">
    <h3>Adhyay ${shloka.adhyay}, Shloka ${shloka.shloka}</h3>
    <p class="shloka-text">${formattedText}</p>

    <div class="shloka-actions">
      <button class="shloka-action-button like-button"
              data-id="${shloka._id}"
              ${isLiked ? 'disabled' : ''}>
        ‚ù§Ô∏è <span class="like-count">${shloka.likes || 0}</span>
      </button>

      <button class="shloka-action-button share-button"
              data-url="${shareUrl}"
              data-title="${shareTitle}"
              data-text="${shareText}">
        üîó Share
      </button>
    </div>
  </div>
`;
      return item;
    }

    // Page load hone par shlok fetch karo (UPDATED - Reverted to ID)
    document.addEventListener('DOMContentLoaded', async () => {
      if (!currentUser) showAuth();
      const container = document.getElementById('single-shloka-container');

      // 1. URL se ID nikalo (e.g., ?id=12345)
      const params = new URLSearchParams(window.location.search);
      const shlokaId = params.get('id'); // 'id' se fetch karein

      if (!shlokaId) {
        container.innerHTML = "<p>Error: No shloka ID provided.</p>";
        return;
      }

      // 2. Puraane API route se data fetch karo
      try {
        // [FIX] Cache buster add kiya gaya
        const cacheBuster = `?cache_buster=${new Date().getTime()}`;
        const response = await fetch(`/api/shloka/${shlokaId}${cacheBuster}`);

        if (!response.ok) {
          const errorData = await response.json();
          throw new Error(errorData.message || 'Shloka not found');
        }

        const shloka = await response.json();

        // Load site info for social links
        try {
          const sr = await fetch('/api/settings');
          const settings = await sr.json();
          const socBox = document.getElementById('social-links');
          if (socBox) {
            socBox.innerHTML = '';
            const icons = { instagram: 'fab fa-instagram', youtube: 'fab fa-youtube', twitter: 'fab fa-twitter', facebook: 'fab fa-facebook' };
            if (settings.personalLink) {
              if (settings.personalLinkLogo) {
                socBox.innerHTML += `<a href="${settings.personalLink}" target="_blank" class="social-icon"><img src="${settings.personalLinkLogo}" style="height:24px; width:24px; border-radius:50%; vertical-align:middle;"></a>`;
              } else {
                socBox.innerHTML += `<a href="${settings.personalLink}" target="_blank" class="social-icon"><i class="fas fa-globe"></i></a>`;
              }
            }
            if (settings.social) {
              Object.keys(settings.social).forEach(key => {
                const url = settings.social[key];
                if (url) socBox.innerHTML += `<a href="${url}" target="_blank" class="social-icon"><i class="${icons[key]}"></i></a>`;
              });
            }
          }
        } catch (e) { console.error("Settings load error", e); }

        container.innerHTML = '';
        const shlokaCard = createSingleShlokaCard(shloka);
        container.appendChild(shlokaCard);

        // --- Mobile Menu ---
        const menuBtn = document.getElementById('menu-btn');
        const navLinks = document.getElementById('nav-links');
        if (menuBtn && navLinks) {
          menuBtn.onclick = () => {
            navLinks.classList.toggle('active');
          };
        }

        if (shloka.video_id) {
          pendingPlayers.push({
            elementId: `yt-single-${shloka._id}`,
            videoId: shloka.video_id,
            shlokaId: shloka._id
          });
          createPendingPlayers();
          setTimeout(() => {
            const el = document.getElementById(`yt-single-${shloka._id}`);
            if (el && el.childElementCount === 0) {
              renderIframeFallback(`yt-single-${shloka._id}`, shloka.video_id);
            }
          }, 2000);
        } else {
          const el = document.getElementById(`yt-single-${shloka._id}`);
          if (el) {
            el.innerHTML = `<div style="display:flex; align-items:center; justify-content:center; height:100%; color:#fff;">Video unavailable</div>`;
          }
        }

      } catch (err) {
        console.error(err);
        container.innerHTML = `<p>Error: ${err.message}</p>`;
      }
    });

    // 3. Like/Share button logic (No Change)
    document.getElementById('single-shloka-container').addEventListener('click', async (e) => {
      const shareButton = e.target.closest('.share-button');
      if (shareButton) {
        const urlToShare = shareButton.dataset.url;
        const title = shareButton.dataset.title;
        const text = shareButton.dataset.text;
        if (navigator.share) {
          try { await navigator.share({ title: title, text: text, url: urlToShare }); }
          catch (err) { console.error('Share failed:', err); }
        } else {
          try { await navigator.clipboard.writeText(urlToShare); alert('Link copied to clipboard!'); }
          catch (err) { alert('Failed to copy link.'); }
        }
      }
      const likeButton = e.target.closest('.like-button');
      if (likeButton) {
        const shlokaDbId = likeButton.dataset.id;
        if (localStorage.getItem('liked_' + shlokaDbId)) { return; }
        likeButton.disabled = true;
        try {
          const response = await fetch(`/api/shloka/like/${shlokaDbId}`, { method: 'POST' });
          const data = await response.json();
          if (data.success) {
            const countSpan = likeButton.querySelector('.like-count');
            countSpan.textContent = data.likes;
            localStorage.setItem('liked_' + shlokaDbId, 'true');
          } else { likeButton.disabled = false; }
        } catch (err) { likeButton.disabled = false; }
      }
    });
  </script>
  <script src="https://www.youtube.com/iframe_api"></script>
  <script src="pwa.js"></script>
  <script>
    function onYouTubeIframeAPIReady() {
      ytApiReady = true;
      createPendingPlayers();
    }
  </script>
</body>

</html>
