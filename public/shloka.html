<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Gitadhya - Gita by Aaradhya</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;600;700;900&display=swap"
    rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <link rel="stylesheet" href="style.css">
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-messaging-compat.js"></script>
  <link rel="manifest" href="/site.webmanifest">
</head>

<body>

  <div class="auth-overlay" id="auth-overlay">
    <div class="auth-modal" id="login-modal">
      <button class="auth-close" onclick="closeAuth()" aria-label="Close">‚úï</button>
      <h2 data-i18n="auth_login_title">Haree Krishna,</h2>
      <form id="student-login-form">
        <input type="tel" id="l-mobile" placeholder="Mobile Number" data-i18n-placeholder="auth_mobile_placeholder"
          required>
        <input type="password" id="l-pass" placeholder="Password" data-i18n-placeholder="auth_password_placeholder"
          required>
        <button type="submit" class="auth-btn" data-i18n="auth_login_btn">Login to Continue</button>
      </form>
      <div class="auth-switch" onclick="switchAuth('register')" data-i18n="auth_login_switch">‡§®‡§è ‡§π‡•à‡§Ç? Register here</div>
    </div>

    <div class="auth-modal" id="register-modal" style="display:none;">
      <button class="auth-close" onclick="closeAuth()" aria-label="Close">‚úï</button>
      <h2 data-i18n="auth_register_title">Join the Journey,</h2>
      <form id="student-register-form">
        <input type="text" id="r-name" placeholder="Your Full Name" data-i18n-placeholder="auth_name_placeholder"
          required>
        <div style="font-size:0.85rem; color:var(--text-muted); margin:-4px 0 10px;" data-i18n="auth_note">
          Phone number ‡§µ‡§π‡•Ä ‡§°‡§æ‡§≤‡•á‡§Ç ‡§ú‡§ø‡§∏ ‡§™‡§∞ ‡§Ü‡§™ certificate receive ‡§ï‡§∞‡•á‡§Ç‡§ó‡•á
        </div>
        <input type="tel" id="r-mobile" placeholder="Mobile Number" data-i18n-placeholder="auth_mobile_placeholder"
          required>
        <input type="password" id="r-pass" placeholder="Create Password" data-i18n-placeholder="auth_password_placeholder"
          required>
        <button type="submit" class="auth-btn" data-i18n="auth_register_btn">Register</button>
      </form>
      <div class="auth-switch" onclick="switchAuth('login')" data-i18n="auth_register_switch">Already registered? Login here</div>
    </div>
  </div>

  <nav class="top-navbar">
    <div class="container nav-container">
      <div class="logo">
        <a href="index.html">Gitadhya-Gita by Aaradhya</a>
      </div>
      <div class="menu-links" id="nav-links">
        <a href="index.html" class="main-tab-button" data-i18n="nav_home">Home</a>
        <a href="about.html" class="main-tab-button" data-i18n="nav_about">About</a>
        <a href="courses.html" class="main-tab-button" data-i18n="nav_courses">Courses</a>
        <a href="artwork.html" class="main-tab-button" data-i18n="nav_art">Art</a>
        <a href="blog.html" class="main-tab-button" data-i18n="nav_blog">Blog</a>
        <a href="testimonials.html" class="main-tab-button" data-i18n="nav_testimonials">Testimonials</a>
        <a href="Gitadhya.apk" class="main-tab-button" data-i18n="nav_download_app">Download App</a>
        <button class="main-tab-button" id="back-btn" onclick="goBack()"
          style="display:none; background:#eee; border-radius: 10px;">
          <i class="fas fa-arrow-left"></i> <span data-i18n="nav_all_courses">All Courses</span>
        </button>
        <div id="auth-box">
          <a href="index.html?auth=true" class="main-tab-button" data-i18n="nav_login">Login</a>
        </div>
      </div>
      <button class="menu-toggle" id="menu-btn"><i class="fas fa-bars"></i></button>
    </div>
    </nav>

    <div class="auth-overlay" id="profile-overlay" style="display:none;">
        <div class="auth-modal" id="profile-modal" style="max-width:520px;">
            <button class="auth-close" onclick="closeProfile()" aria-label="Close">‚úï</button>
            <h2>My Account</h2>
            <p style="color:var(--text-muted); margin:-10px 0 20px; font-size:0.95rem;">
                Apne details update kar sakte ho. Password change ke liye current password zaroor daalein.
            </p>
            <form id="profile-form" style="display:grid; gap:12px;">
                <input id="profile-name" placeholder="Full Name" required>
                <input id="profile-mobile" placeholder="Mobile Number" readonly>
                <input id="profile-current-pass" type="password" placeholder="Current Password" required>
                <input id="profile-new-pass" type="password" placeholder="New Password (optional)">
                <button class="auth-btn" type="submit">Save Changes</button>
            </form>
        </div>
    </div>

  <header class="shloka-welcome-hero" style="padding-top:120px;">
    <div class="container">
      <div class="verified-badge-inline">
        <span class="dot"></span>
        <span data-i18n="hero_shloka_badge">Gita By Aaradhya</span>
      </div>
      <h1 data-i18n="hero_shloka_title">Divine Shloka</h1>
      <p class="subtitle" data-i18n="hero_shloka_subtitle">Listen, reflect, and share the sacred verses.</p>
    </div>
  </header>

  <div class="container" style="padding: 40px 0 80px;">
    <main id="single-shloka-container" style="max-width: 900px; margin: 0 auto;">
      <p style="text-align:center; color:var(--text-muted);" data-i18n="shloka_loading">Loading shloka...</p>
    </main>
    <div style="text-align:center; margin-top: 35px;">
      <a href="courses.html" class="auth-btn"
        style="padding: 12px 26px; text-decoration:none; display:inline-block; width:auto;">
        <span data-i18n="shloka_explore_btn">Explore All Adhyays</span>
      </a>
    </div>
  </div>

  <footer class="main-footer">
    <div class="container">
      <div class="footer-grid">
        <div>
          <div class="footer-badge"><i class="fas fa-seedling"></i> Gitadhya</div>
          <h2 id="footer-logo-text">Gita by Aaradhya</h2>
          <p data-i18n="footer_tagline">Rooted in the Bhagavad Gita, guided by devotion, and shared with love for every seeker.</p>
          <div class="social-row" id="social-links"></div>
        </div>
        <div class="footer-links">
          <h3 data-i18n="footer_explore">Explore</h3>
          <a href="index.html"><i class="fas fa-home"></i> <span data-i18n="nav_home">Home</span></a>
          <a href="courses.html"><i class="fas fa-graduation-cap"></i> <span data-i18n="nav_courses">Courses</span></a>
          <a href="artwork.html"><i class="fas fa-palette"></i> <span data-i18n="nav_art">Art</span></a>
          <a href="blog.html"><i class="fas fa-pen-nib"></i> <span data-i18n="nav_blog">Blog</span></a>
          <a href="testimonials.html"><i class="fas fa-heart"></i> <span data-i18n="nav_testimonials">Testimonials</span></a>
        </div>
        <div class="footer-contact">
          <h3 data-i18n="footer_contact">Contact</h3>
          <a href="tel:+919243714402"><i class="fas fa-phone"></i> +91 9243714402</a>
          <a href="mailto:warrioraaradhya111@gmail.com"><i class="fas fa-envelope"></i> warrioraaradhya111@gmail.com</a>
        </div>
      </div>
      <div class="footer-bottom">
        <span data-i18n="footer_bottom_left">&copy; 2026 Gitadhya | Gita by Aaradhya</span>
        <span data-i18n="footer_bottom_right">Guided by devotion, shared with love.</span>
      </div>
    </div>
  </footer>

  <script>
    let ytApiReady = false;
    let pendingPlayers = [];

    let currentUser = null;
    try {
      currentUser = JSON.parse(localStorage.getItem('gitadhya_user'));
    } catch (e) {
      localStorage.removeItem('gitadhya_user');
    }
    const userMobile = currentUser && currentUser.mobile ? currentUser.mobile : '';

    function showAuth() { document.getElementById('auth-overlay').style.display = 'flex'; }
    function closeAuth() { document.getElementById('auth-overlay').style.display = 'none'; }
    function switchAuth(type) {
      document.getElementById('login-modal').style.display = type === 'login' ? 'block' : 'none';
      document.getElementById('register-modal').style.display = type === 'register' ? 'block' : 'none';
    }

    const isLoggedIn = !!(currentUser && currentUser.mobile);
    if (!isLoggedIn) {
      window.addEventListener('load', () => {
        showAuth();
      });
    } else {
      closeAuth();
    }

    document.getElementById('student-register-form').onsubmit = async (e) => {
      e.preventDefault();
      const res = await fetch('/api/student/register', {
        method: 'POST', headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ name: document.getElementById('r-name').value, mobile: document.getElementById('r-mobile').value, password: document.getElementById('r-pass').value })
      });
      const d = await res.json();
      if (d.success) { localStorage.setItem('gitadhya_user', JSON.stringify(d.student)); location.reload(); }
      else alert(d.message);
    };

    document.getElementById('student-login-form').onsubmit = async (e) => {
      e.preventDefault();
      const res = await fetch('/api/student/login', {
        method: 'POST', headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ mobile: document.getElementById('l-mobile').value, password: document.getElementById('l-pass').value })
      });
      const d = await res.json();
      if (d.success) { localStorage.setItem('gitadhya_user', JSON.stringify(d.student)); location.reload(); }
      else alert(d.message);
    };

    function openProfile() { document.getElementById('profile-overlay').style.display = 'flex'; }
    function closeProfile() { document.getElementById('profile-overlay').style.display = 'none'; }
    function initProfileModal() {
      const form = document.getElementById('profile-form');
      if (!form || !currentUser) return;
      document.getElementById('profile-name').value = currentUser.name || '';
      document.getElementById('profile-mobile').value = currentUser.mobile || '';

      form.onsubmit = async (e) => {
        e.preventDefault();
        const payload = {
          name: document.getElementById('profile-name').value.trim(),
          mobile: document.getElementById('profile-mobile').value.trim(),
          currentPassword: document.getElementById('profile-current-pass').value,
          newPassword: document.getElementById('profile-new-pass').value.trim()
        };
        const res = await fetch('/api/student/update', {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(payload)
        });
        const d = await res.json();
        if (res.ok && d.success) {
          localStorage.setItem('gitadhya_user', JSON.stringify(d.student));
          currentUser = d.student;
          document.getElementById('profile-current-pass').value = '';
          document.getElementById('profile-new-pass').value = '';
          updateAuthUI();
          alert('Profile updated successfully!');
          closeProfile();
        } else {
          alert(d.message || 'Profile update failed');
        }
      };
    }

    function updateAuthUI() {
      const box = document.getElementById('auth-box');
      if (!box) return;
      if (currentUser && currentUser.name) {
        box.innerHTML = `
          <div class="auth-user-badge">
            <i class="fas fa-user-circle"></i>
            <span id="profile-trigger" style="cursor:pointer;">${currentUser.name}</span>
            <i class="fas fa-sign-out-alt" onclick="logout()" style="cursor:pointer; color:var(--primary);"></i>
          </div>
        `;
        const trigger = document.getElementById('profile-trigger');
        if (trigger) trigger.onclick = () => { initProfileModal(); openProfile(); };
      }
    }
    function logout() { localStorage.removeItem('gitadhya_user'); location.reload(); }
    updateAuthUI();

    function createPendingPlayers() {
      if (!ytApiReady) return;

      pendingPlayers.forEach(p => {
        if (p._created) return; // duplicate se bachao
        p._created = true;

        try {
          new YT.Player(p.elementId, {
            videoId: p.videoId,
            width: '100%',
            height: '100%',
            playerVars: {
              enablejsapi: 1,
              origin: window.location.origin
            },
            events: {
              onStateChange: (e) => {
                if (e.data === YT.PlayerState.ENDED) {
                  const courseId = localStorage.getItem('active_course');
                  if (!courseId || !userMobile) return;

                  fetch('/api/progress/save', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                      mobile: userMobile,
                      courseId,
                      completed: [p.shlokaId]
                    })
                  });

                  console.log('‚úÖ COMPLETED (ENDED)', p.shlokaId);
                }
              }
            }
          });
        } catch (err) {
          renderIframeFallback(p.elementId, p.videoId);
        }
      });
    }

    function renderIframeFallback(elementId, videoId) {
      const el = document.getElementById(elementId);
      if (!el || !videoId) return;
      el.innerHTML = `
        <iframe src="https://www.youtube.com/embed/${videoId}"
          title="Shloka Video"
          frameborder="0"
          allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture"
          allowfullscreen></iframe>
      `;
    }

    function createSingleShlokaCard(shloka) {
      const item = document.createElement('div');
      item.className = 'shloka-item-card';

      const formattedText = shloka.text ? shloka.text.replace(/\n/g, '<br>') : '';
      const isLiked = localStorage.getItem('liked_' + shloka._id) === 'true';
      const shareTitle = `Aaradhya Soni - Gita Adhyay ${shloka.adhyay}, Shloka ${shloka.shloka}`;
      const shareText = `Listen to Aaradhya's recitation of Gita Adhyay ${shloka.adhyay}, Shloka ${shloka.shloka}`;
      const shareUrl = `${window.location.origin}/adhyay-${shloka.adhyay}/shlok-${shloka.shloka}`;

      item.innerHTML = `
  <div class="card-video-container">
    <div id="yt-single-${shloka._id}" data-video-id="${shloka.video_id || ''}" style="width:100%; height:100%;"></div>
  </div>

  <div class="card-content">
    <h3 style="display:flex; align-items:center; gap:8px;">
      <span>Adhyay ${shloka.adhyay}, Shloka ${shloka.shloka}</span>
      <a href="/adhyay-${shloka.adhyay}/shlok-${shloka.shloka}" target="_blank" rel="noopener noreferrer" title="Open in new tab" style="text-decoration:none; color:var(--primary);">‚Üó</a>
    </h3>
    <p class="shloka-text">${formattedText}</p>

    <div class="shloka-actions">
      <button class="shloka-action-button like-button"
              data-id="${shloka._id}"
              ${isLiked ? 'disabled' : ''}>
        ‚ù§Ô∏è <span class="like-count">${shloka.likes || 0}</span>
      </button>

      <button class="shloka-action-button share-button"
              data-url="${shareUrl}"
              data-title="${shareTitle}"
              data-text="${shareText}">
        üîó Share
      </button>
    </div>
  </div>
`;
      return item;
    }

    // Page load hone par shlok fetch karo (UPDATED - Reverted to ID)
    document.addEventListener('DOMContentLoaded', async () => {
      if (!currentUser) showAuth();
      const container = document.getElementById('single-shloka-container');

      // 1. URL se ID ya clean route params nikalo
      const params = new URLSearchParams(window.location.search);
      const shlokaId = params.get('id'); // 'id' se fetch karein
      const pathMatch = window.location.pathname.match(/^\/adhyay-(\d+)\/shlok-(\d+)$/);

      // 2. API route se data fetch karo
      try {
        // [FIX] Cache buster add kiya gaya
        const cacheBuster = `?cache_buster=${new Date().getTime()}`;
        const apiPath = shlokaId
          ? `/api/shloka/${shlokaId}${cacheBuster}`
          : pathMatch
            ? `/api/shloka/by-reference/${pathMatch[1]}/${pathMatch[2]}${cacheBuster}`
            : null;
        if (!apiPath) {
          container.innerHTML = "<p>Error: No shloka identifier provided.</p>";
          return;
        }
        const response = await fetch(apiPath);

        if (!response.ok) {
          const errorData = await response.json();
          throw new Error(errorData.message || 'Shloka not found');
        }

        const shloka = await response.json();

        // Load site info for social links
        try {
          const sr = await fetch('/api/settings');
          const settings = await sr.json();
          const socBox = document.getElementById('social-links');
          if (socBox) {
            socBox.innerHTML = '';
            const icons = { instagram: 'fab fa-instagram', youtube: 'fab fa-youtube', twitter: 'fab fa-twitter', facebook: 'fab fa-facebook' };
            if (settings.personalLink) {
              if (settings.personalLinkLogo) {
                socBox.innerHTML += `<a href="${settings.personalLink}" target="_blank" class="social-icon"><img src="${settings.personalLinkLogo}" style="height:24px; width:24px; border-radius:50%; vertical-align:middle;"></a>`;
              } else {
                socBox.innerHTML += `<a href="${settings.personalLink}" target="_blank" class="social-icon"><i class="fas fa-globe"></i></a>`;
              }
            }
            if (settings.social) {
              Object.keys(settings.social).forEach(key => {
                const url = settings.social[key];
                if (url) socBox.innerHTML += `<a href="${url}" target="_blank" class="social-icon"><i class="${icons[key]}"></i></a>`;
              });
            }
          }
        } catch (e) { console.error("Settings load error", e); }

        container.innerHTML = '';
        const shlokaCard = createSingleShlokaCard(shloka);
        container.appendChild(shlokaCard);

        // --- Mobile Menu ---
        const menuBtn = document.getElementById('menu-btn');
        const navLinks = document.getElementById('nav-links');
        if (menuBtn && navLinks) {
          menuBtn.onclick = () => {
            navLinks.classList.toggle('active');
          };
        }

        if (shloka.video_id) {
          pendingPlayers.push({
            elementId: `yt-single-${shloka._id}`,
            videoId: shloka.video_id,
            shlokaId: shloka._id
          });
          createPendingPlayers();
          setTimeout(() => {
            const el = document.getElementById(`yt-single-${shloka._id}`);
            if (el && el.childElementCount === 0) {
              renderIframeFallback(`yt-single-${shloka._id}`, shloka.video_id);
            }
          }, 2000);
        } else {
          const el = document.getElementById(`yt-single-${shloka._id}`);
          if (el) {
            el.innerHTML = `<div style="display:flex; align-items:center; justify-content:center; height:100%; color:#fff;">Video unavailable</div>`;
          }
        }

      } catch (err) {
        console.error(err);
        container.innerHTML = `<p>Error: ${err.message}</p>`;
      }
    });

    // 3. Like/Share button logic (No Change)
    document.getElementById('single-shloka-container').addEventListener('click', async (e) => {
      const shareButton = e.target.closest('.share-button');
      if (shareButton) {
        const urlToShare = shareButton.dataset.url;
        const title = shareButton.dataset.title;
        const text = shareButton.dataset.text;
        if (navigator.share) {
          try { await navigator.share({ title: title, text: text, url: urlToShare }); }
          catch (err) { console.error('Share failed:', err); }
        } else {
          try { await navigator.clipboard.writeText(urlToShare); alert('Link copied to clipboard!'); }
          catch (err) { alert('Failed to copy link.'); }
        }
      }
      const likeButton = e.target.closest('.like-button');
      if (likeButton) {
        const shlokaDbId = likeButton.dataset.id;
        if (localStorage.getItem('liked_' + shlokaDbId)) { return; }
        likeButton.disabled = true;
        try {
          const response = await fetch(`/api/shloka/like/${shlokaDbId}`, { method: 'POST' });
          const data = await response.json();
          if (data.success) {
            const countSpan = likeButton.querySelector('.like-count');
            countSpan.textContent = data.likes;
            localStorage.setItem('liked_' + shlokaDbId, 'true');
          } else { likeButton.disabled = false; }
        } catch (err) { likeButton.disabled = false; }
      }
    });
  </script>
  <script src="https://www.youtube.com/iframe_api"></script>
  <script src="pwa.js"></script>
  <script>
    function onYouTubeIframeAPIReady() {
      ytApiReady = true;
      createPendingPlayers();
    }
  </script>
  <script src="/geeta-saarathi.js"></script>
</body>

</html>




