<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Aaradhya Geetaji | Admin Panel</title>

    <link rel="icon" href="/favicon.png">
    <link rel="stylesheet" href="admin-style.css">
</head>
<body>

<!-- ================= LOGIN ================= -->
<section id="login-section">
    <div class="login-card">
        <h2>Admin Login</h2>
        <p>Restricted access</p>

        <form id="login-form">
            <input
                id="password"
                type="password"
                class="form-control"
                placeholder="Admin Password"
                autocomplete="current-password"
                required
            >
            <button class="btn btn-primary" style="width:100%;margin-top:1rem">
                Login
            </button>
        </form>
    </div>
</section>

<!-- ================= ADMIN ================= -->
<div id="admin-layout" class="admin-layout" style="display:none;">

    <!-- SIDEBAR -->
    <aside class="sidebar">
        <div class="brand">âš¡ AdminOS</div>

        <div class="nav-scroll">
            <div class="nav-group">
                <div class="nav-label">Overview</div>
                <div class="nav-item active" onclick="switchTab('dashboard')">Dashboard</div>
            </div>

            <div class="nav-group">
                <div class="nav-label">CMS</div>
                <div class="nav-item" onclick="switchTab('shlokas')">Shlokas</div>
                <div class="nav-item" onclick="switchTab('blogs')">Blogs</div>
                <div class="nav-item" onclick="switchTab('artwork')">Artwork</div>
                <div class="nav-item" onclick="switchTab('testimonials')">Testimonials</div>
            </div>

            <div class="nav-group">
                <div class="nav-label">LMS</div>
                <div class="nav-item" onclick="switchTab('courses')">Courses</div>
                <div class="nav-item" onclick="switchTab('quizzes')">Quizzes</div>
                <div class="nav-item" onclick="switchTab('certificates')">Certificates</div>
            </div>

            <div class="nav-group">
                <div class="nav-label">System</div>
                <div class="nav-item" onclick="switchTab('settings')">Settings</div>
            </div>
        </div>

        <div class="sidebar-footer">
            <button class="logout-btn" onclick="location.reload()">Logout</button>
        </div>
    </aside>

    <!-- MAIN -->
    <main class="main-wrapper">

        <header class="top-header">
            <div id="page-title" class="page-title">Dashboard</div>
        </header>

        <!-- âœ… FIX: THIS is the scrolling container -->
        <div class="content-scroll">
            <!-- ================= DASHBOARD ================= -->
            <section id="view-dashboard" class="view-section active">
                <div id="stats-grid" class="stats-grid"></div>

                <div class="data-card">
                    <div class="card-header">
                        <h3 class="card-title">Pending Actions</h3>
                    </div>
                    <div id="dashboard-alerts" class="modal-body"></div>
                </div>
            </section>

            <!-- ================= SHLOKAS ================= -->
            <section id="view-shlokas" class="view-section">
                <div class="data-card">
                    <div class="card-header">
                        <h3 class="card-title">Shlokas</h3>
                        <button class="btn btn-primary btn-sm" onclick="openShloka()">+ Add</button>
                    </div>

                    <!-- âœ… scroll fix -->
                    <div class="table-responsive" style="max-height:65vh;overflow:auto">
                        <table>
                            <thead>
                                <tr>
                                    <th>Adhyay</th>
                                    <th>Shloka</th>
                                    <th>Text</th>
                                    <th style="text-align:right">Actions</th>
                                </tr>
                            </thead>
                            <tbody id="table-shlokas"></tbody>
                        </table>
                    </div>
                </div>
            </section>

            <!-- ================= BLOGS ================= -->
            <section id="view-blogs" class="view-section">
                <div class="data-card">
                    <div class="card-header">
                        <h3 class="card-title">Blogs</h3>
                        <button class="btn btn-primary btn-sm" onclick="openBlog()">+ Add</button>
                    </div>

                    <div class="table-responsive">
                        <table>
                            <thead>
                                <tr>
                                    <th>Title</th>
                                    <th>Date</th>
                                    <th style="text-align:right">Actions</th>
                                </tr>
                            </thead>
                            <tbody id="table-blogs"></tbody>
                        </table>
                    </div>
                </div>
            </section>

            <!-- ================= ARTWORK ================= -->
            <section id="view-artwork" class="view-section">
                <div class="data-card">
                    <div class="card-header">
                        <h3 class="card-title">Artwork</h3>
                        <button class="btn btn-primary btn-sm" onclick="openArtwork()">+ Add</button>
                    </div>

                    <div class="table-responsive">
                        <table>
                            <thead>
                                <tr>
                                    <th>Preview</th>
                                    <th>Title</th>
                                    <th style="text-align:right">Actions</th>
                                </tr>
                            </thead>
                            <tbody id="table-artwork"></tbody>
                        </table>
                    </div>
                </div>
            </section>

            <!-- ================= TESTIMONIALS ================= -->
            <section id="view-testimonials" class="view-section">
                <div class="data-card">
                    <div class="card-header">
                        <h3 class="card-title">Testimonials</h3>
                        <button class="btn btn-primary btn-sm" onclick="openTestimonial()">+ Add</button>
                    </div>

                    <div class="table-responsive">
                        <table>
                            <thead>
                                <tr>
                                    <th>Name</th>
                                    <th>Message</th>
                                    <th>Status</th>
                                    <th style="text-align:right">Actions</th>
                                </tr>
                            </thead>
                            <tbody id="table-testimonials"></tbody>
                        </table>
                    </div>
                </div>
            </section>

            <!-- ================= COURSES ================= -->
            <section id="view-courses" class="view-section">
                <div class="data-card">
                    <div class="card-header">
                        <h3 class="card-title">Courses</h3>
                        <button class="btn btn-primary btn-sm" onclick="openCourse()">+ Add</button>
                    </div>
                    <div id="course-list-container" style="padding:1.5rem"></div>
                </div>
            </section>

            <!-- ================= QUIZZES ================= -->
            <section id="view-quizzes" class="view-section">
                <div class="data-card">
                    <div class="card-header">
                        <h3 class="card-title">Quizzes</h3>
                        <button class="btn btn-primary btn-sm" onclick="openQuiz()">+ Add</button>
                    </div>

                    <div class="table-responsive">
                        <table>
                            <thead>
                                <tr>
                                    <th>Course</th>
                                    <th>Pass %</th>
                                    <th style="text-align:right">Actions</th>
                                </tr>
                            </thead>
                            <tbody id="table-quizzes"></tbody>
                        </table>
                    </div>
                </div>
            </section>

            <!-- ================= CERTIFICATES ================= -->
            <section id="view-certificates" class="view-section">
                <div class="data-card">
                    <div class="card-header">
                        <h3 class="card-title">Certificates</h3>
                    </div>

                    <div class="table-responsive">
                        <table>
                            <thead>
                                <tr>
                                    <th>Name</th>
                                    <th>Course</th>
                                    <th>Status</th>
                                    <th style="text-align:right">Actions</th>
                                </tr>
                            </thead>
                            <tbody id="table-certs"></tbody>
                        </table>
                    </div>
                </div>
            </section>

            <!-- ================= SETTINGS ================= -->
            <section id="view-settings" class="view-section">
                <div class="data-card">
                    <div class="card-header">
                        <h3 class="card-title">About Page</h3>
                    </div>
                    <div class="modal-body">
                        <form id="settings-form">
                            <input id="abt-img" class="form-control" placeholder="Image URL">
                            <textarea id="abt-content" class="form-control" placeholder="About text"
                                style="margin-top:10px;min-height:150px"></textarea>
                            <button class="btn btn-primary" style="margin-top:10px">Save</button>
                        </form>
                    </div>
                </div>
            </section>

        </div> <!-- content-scroll -->
    </main>
</div>

<!-- ================= MODALS ================= -->

<!-- SHLOKA -->
<div id="modal-shloka" class="modal-overlay">
    <div class="modal-dialog">
        <div class="modal-header">
            <h3>Shloka</h3>
            <button class="btn btn-secondary btn-sm" onclick="closeModal('modal-shloka')">X</button>
        </div>
        <div class="modal-body">
            <form id="form-shloka">
                <input type="hidden" id="shloka-id">
                <input id="s-adhyay" class="form-control" placeholder="Adhyay">
                <input id="s-shloka" class="form-control" placeholder="Shloka" style="margin-top:10px">
                <textarea id="s-text" class="form-control" placeholder="Text"
                    style="margin-top:10px"></textarea>
                <input id="s-video" class="form-control" placeholder="YouTube ID"
                    style="margin-top:10px">
                <button class="btn btn-primary" style="margin-top:10px;width:100%">Save</button>
            </form>
        </div>
    </div>
</div>

<!-- BLOG -->
<div id="blog-modal" class="modal-overlay">
  <div class="modal-dialog">
    <div class="modal-header">
      <h3>Blog</h3>
      <button class="btn btn-secondary btn-sm" onclick="closeModal('blog-modal')">X</button>
    </div>
    <div class="modal-body">
      <form id="blog-form">
        <input id="b-title" class="form-control" placeholder="Title">
        <input id="b-img" class="form-control" placeholder="Image URL" style="margin-top:10px">
        <textarea id="b-content" class="form-control" placeholder="Content"
          style="margin-top:10px;min-height:150px"></textarea>
        <button class="btn btn-primary" style="margin-top:10px;width:100%">Save</button>
      </form>
    </div>
  </div>
</div>

<!-- ARTWORK -->
<div id="modal-artwork" class="modal-overlay">
    <div class="modal-dialog">
        <div class="modal-header">
            <h3>Artwork</h3>
            <button class="btn btn-secondary btn-sm" onclick="closeModal('modal-artwork')">X</button>
        </div>
        <div class="modal-body">
            <form id="form-artwork">
                <input type="hidden" id="artwork-id">
                <input id="art-title" class="form-control" placeholder="Title">
                <input id="art-img" class="form-control" placeholder="Image URL"
                    style="margin-top:10px">
                <button class="btn btn-primary" style="margin-top:10px;width:100%">Save</button>
            </form>
        </div>
    </div>
</div>

<!-- TESTIMONIAL -->
<div id="modal-testimonial" class="modal-overlay">
    <div class="modal-dialog">
        <div class="modal-header">
            <h3>Testimonial</h3>
            <button class="btn btn-secondary btn-sm" onclick="closeModal('modal-testimonial')">X</button>
        </div>
        <div class="modal-body">
            <form id="form-testimonial">
                <input type="hidden" id="testi-id">
                <input id="testi-name" class="form-control" placeholder="Name">
                <textarea id="testi-msg" class="form-control" placeholder="Message"
                    style="margin-top:10px"></textarea>
                <select id="testi-status" class="form-control" style="margin-top:10px">
                    <option value="pending">Pending</option>
                    <option value="approved">Approved</option>
                </select>
                <button class="btn btn-primary" style="margin-top:10px;width:100%">Save</button>
            </form>
        </div>
    </div>
</div>
<script>
/* =====================================================
   SAFE HELPERS
===================================================== */
const qs = (id) => document.getElementById(id);
const qsa = (q) => document.querySelectorAll(q);

let ADMIN_PASSWORD = '';

/* =====================================================
   MODALS
===================================================== */
function openModal(id) {
  const el = qs(id);
  if (el) el.classList.add('open');
}
function closeModal(id) {
  const el = qs(id);
  if (el) el.classList.remove('open');
}

/* =====================================================
   LOGIN
===================================================== */
qs('login-form').addEventListener('submit', async (e) => {
  e.preventDefault();

  const pwd = qs('password').value.trim();
  if (!pwd) return alert('Password required');

  const res = await fetch('/api/login', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ password: pwd })
  });

  if (!res.ok) return alert('Wrong password');

  ADMIN_PASSWORD = pwd;
  qs('login-section').style.display = 'none';
  qs('admin-layout').style.display = 'grid';
  switchTab('dashboard');
});

/* =====================================================
   NAVIGATION (NO UNDEFINED CALLS)
===================================================== */
function switchTab(tab) {
  qsa('.view-section').forEach(v => v.classList.remove('active'));

  const view = qs('view-' + tab);
  if (!view) return;

  view.classList.add('active');
  qs('page-title').innerText = tab.toUpperCase();

  if (tab === 'dashboard') loadDashboard();
  if (tab === 'shlokas') loadShlokas();
  if (tab === 'blogs') loadBlogs();
  if (tab === 'artwork') loadArtwork();
  if (tab === 'testimonials') loadTestimonials();
  if (tab === 'courses') loadCourses();
  if (tab === 'quizzes') loadQuizzes();
  if (tab === 'certificates') loadCertificates();
  if (tab === 'settings') loadSettings();
}

/* =====================================================
   DASHBOARD
===================================================== */
async function loadDashboard() {
  const grid = qs('stats-grid');
  grid.innerHTML = '';

  const endpoints = {
    Shlokas: '/api/shlokas',
    Blogs: '/api/blog',
    Artwork: '/api/artwork',
    Testimonials: '/api/testimonials/all',
    Courses: '/api/courses'
  };

  for (const [label, url] of Object.entries(endpoints)) {
    const data = await fetch(url).then(r => r.json());
    grid.innerHTML += `
      <div class="stat-card">
        <div class="stat-head">${label}</div>
        <div class="stat-value">${data.length || 0}</div>
      </div>`;
  }
}

/* =====================================================
   SHLOKAS
===================================================== */
function openShloka(s = null) {
  qs('form-shloka').reset();
  qs('shloka-id').value = s?._id || '';
  qs('s-adhyay').value = s?.adhyay || '';
  qs('s-shloka').value = s?.shloka || '';
  qs('s-text').value = s?.text || '';
  qs('s-video').value = s?.video_id || '';
  openModal('modal-shloka');
}

qs('form-shloka').addEventListener('submit', async e => {
  e.preventDefault();

  const id = qs('shloka-id').value;
  const payload = {
    adhyay: qs('s-adhyay').value,
    shloka: qs('s-shloka').value,
    text: qs('s-text').value,
    video_id: qs('s-video').value,
    password: ADMIN_PASSWORD
  };

  await fetch('/api/shlokas' + (id ? '/' + id : ''), {
    method: id ? 'PUT' : 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify(payload)
  });

  closeModal('modal-shloka');
  loadShlokas();
});

async function loadShlokas() {
  const tb = qs('table-shlokas');
  tb.innerHTML = '';
  const data = await fetch('/api/shlokas').then(r => r.json());

  data.forEach(s => {
    tb.innerHTML += `
      <tr>
        <td>${s.adhyay}</td>
        <td>${s.shloka}</td>
        <td>${(s.text||'').slice(0,40)}</td>
        <td style="text-align:right">
          <button class="btn btn-secondary btn-sm"
            onclick='openShloka(${JSON.stringify(s)})'>Edit</button>
          <button class="btn btn-danger btn-sm"
            onclick="deleteShloka('${s._id}')">Delete</button>
        </td>
      </tr>`;
  });
}

async function deleteShloka(id) {
  if (!confirm('Delete shloka?')) return;
  await fetch('/api/shlokas/' + id, {
    method: 'DELETE',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ password: ADMIN_PASSWORD })
  });
  loadShlokas();
}
/* =====================================================
   BLOGS
===================================================== */
function openBlog(b = null) {
  qs('blog-form').reset();
  if (b) {
    qs('b-title').value = b.title || '';
    qs('b-img').value = b.imageUrl || '';
    qs('b-content').value = b.content || '';
  }
  openModal('blog-modal');
}

qs('blog-form').addEventListener('submit', async (e) => {
  e.preventDefault();

  await fetch('/api/blog', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({
      title: qs('b-title').value,
      imageUrl: qs('b-img').value,
      content: qs('b-content').value,
      password: ADMIN_PASSWORD
    })
  });

  closeModal('blog-modal');
  loadBlogs();
});

async function loadBlogs() {
  const tb = qs('table-blogs');
  tb.innerHTML = '';
  const blogs = await fetch('/api/blog').then(r => r.json());

  blogs.forEach(b => {
    tb.innerHTML += `
      <tr>
        <td>${b.title}</td>
        <td>${new Date(b.createdAt).toLocaleDateString()}</td>
        <td style="text-align:right">
          <button class="btn btn-danger btn-sm"
            onclick="deleteBlog('${b._id}')">Delete</button>
        </td>
      </tr>`;
  });
}

async function deleteBlog(id) {
  await fetch('/api/blog/' + id, {
    method: 'DELETE',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ password: ADMIN_PASSWORD })
  });
  loadBlogs();
}

/* =====================================================
   ARTWORK
===================================================== */
function openArtwork(a = null) {
  qs('form-artwork').reset();
  qs('artwork-id').value = a?._id || '';
  qs('art-title').value = a?.title || '';
  qs('art-img').value = a?.imageUrl || '';
  openModal('modal-artwork');
}

qs('form-artwork').addEventListener('submit', async e => {
  e.preventDefault();
  const id = qs('artwork-id').value;

  await fetch('/api/artwork' + (id ? '/' + id : ''), {
    method: id ? 'PUT' : 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({
      title: qs('art-title').value,
      imageUrl: qs('art-img').value,
      password: ADMIN_PASSWORD
    })
  });

  closeModal('modal-artwork');
  loadArtwork();
});

async function loadArtwork() {
  const tb = qs('table-artwork');
  tb.innerHTML = '';
  const art = await fetch('/api/artwork').then(r => r.json());

  art.forEach(a => {
    tb.innerHTML += `
      <tr>
        <td><img src="${a.imageUrl}" style="height:40px"></td>
        <td>${a.title}</td>
        <td style="text-align:right">
          <button class="btn btn-secondary btn-sm"
            onclick='openArtwork(${JSON.stringify(a)})'>Edit</button>
          <button class="btn btn-danger btn-sm"
            onclick="deleteArtwork('${a._id}')">Delete</button>
        </td>
      </tr>`;
  });
}

async function deleteArtwork(id) {
  await fetch('/api/artwork/' + id, {
    method: 'DELETE',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ password: ADMIN_PASSWORD })
  });
  loadArtwork();
}

/* =====================================================
   TESTIMONIALS
===================================================== */
function openTestimonial(t = null) {
  qs('form-testimonial').reset();
  qs('testi-id').value = t?._id || '';
  qs('testi-name').value = t?.author || '';
  qs('testi-msg').value = t?.quote || '';
  qs('testi-status').value = t?.status || 'pending';
  openModal('modal-testimonial');
}

qs('form-testimonial').addEventListener('submit', async e => {
  e.preventDefault();
  const id = qs('testi-id').value;

  await fetch('/api/testimonials' + (id ? '/' + id : ''), {
    method: id ? 'PUT' : 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({
      author: qs('testi-name').value,
      quote: qs('testi-msg').value,
      status: qs('testi-status').value,
      password: ADMIN_PASSWORD
    })
  });

  closeModal('modal-testimonial');
  loadTestimonials();
});

async function loadTestimonials() {
  const tb = qs('table-testimonials');
  tb.innerHTML = '';
  const t = await fetch('/api/testimonials/all').then(r => r.json());

  t.forEach(ti => {
    tb.innerHTML += `
      <tr>
        <td>${ti.author}</td>
        <td>${ti.quote.slice(0,40)}</td>
        <td>${ti.status}</td>
        <td style="text-align:right">
          <button class="btn btn-secondary btn-sm"
            onclick='openTestimonial(${JSON.stringify(ti)})'>Edit</button>
          <button class="btn btn-danger btn-sm"
            onclick="deleteTestimonial('${ti._id}')">Delete</button>
        </td>
      </tr>`;
  });
}

async function deleteTestimonial(id) {
  await fetch('/api/testimonials/' + id, {
    method: 'DELETE',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ password: ADMIN_PASSWORD })
  });
  loadTestimonials();
}

/* =====================================================
   COURSES
===================================================== */
async function loadCourses() {
  const box = qs('course-list-container');
  box.innerHTML = '';
  const courses = await fetch('/api/courses').then(r => r.json());

  courses.forEach(c => {
    box.innerHTML += `
      <div class="data-card" style="margin-bottom:1rem">
        <div class="card-header">
          <b>${c.title}</b>
          <button class="btn btn-danger btn-sm"
            onclick="deleteCourse('${c._id}')">Delete</button>
        </div>
      </div>`;
  });
}

async function deleteCourse(id) {
  if (!confirm('Delete course?')) return;
  await fetch('/api/courses/' + id, { method: 'DELETE' });
  loadCourses();
}

/* =====================================================
   QUIZZES (ðŸ”¥ FIXED)
===================================================== */
async function loadQuizzes() {
  const tb = qs('table-quizzes');
  tb.innerHTML = '';
  const quizzes = await fetch('/api/quiz').then(r => r.json());

  quizzes.forEach(q => {
    tb.innerHTML += `
      <tr>
        <td>${q.course?.title || 'â€”'}</td>
        <td>${q.passPercentage}%</td>
        <td style="text-align:right">
          <button class="btn btn-danger btn-sm"
            onclick="deleteQuiz('${q._id}')">Delete</button>
        </td>
      </tr>`;
  });
}

async function deleteQuiz(id) {
  await fetch('/api/quiz/' + id, {
    method: 'DELETE',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ password: ADMIN_PASSWORD })
  });
  loadQuizzes();
}

/* =====================================================
   CERTIFICATES
===================================================== */
async function loadCertificates() {
  const tb = qs('table-certs');
  tb.innerHTML = '';
  const certs = await fetch('/api/certificates').then(r => r.json());

  certs.forEach(c => {
    tb.innerHTML += `
      <tr>
        <td>${c.name}</td>
        <td>${c.courseTitle}</td>
        <td>${c.status}</td>
        <td style="text-align:right">
          <button class="btn btn-danger btn-sm"
            onclick="deleteCertificate('${c._id}')">Delete</button>
        </td>
      </tr>`;
  });
}

async function deleteCertificate(id) {
  await fetch('/api/certificates/' + id, { method: 'DELETE' });
  loadCertificates();
}

/* =====================================================
   SETTINGS
===================================================== */
async function loadSettings() {
  const data = await fetch('/api/about').then(r => r.json());
  qs('abt-img').value = data.imageUrl || '';
  qs('abt-content').value = data.content || '';
}

qs('settings-form').addEventListener('submit', async e => {
  e.preventDefault();
  await fetch('/api/about', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({
      newText: qs('abt-content').value,
      newImageUrl: qs('abt-img').value,
      password: ADMIN_PASSWORD
    })
  });
  alert('Saved');
});
</script>
