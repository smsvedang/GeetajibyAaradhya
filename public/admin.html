<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Panel | Gitadhya</title>
    <link rel="icon" href="/favicon.ico" sizes="any">
    <link rel="icon" type="image/png" href="/favicon.png">
    <link rel="stylesheet" href="admin-style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>

<body>

    <!-- TOAST CONTAINER -->
    <div id="toast-container"></div>

    <!-- EDIT MODAL OVERLAY -->
    <div id="edit-modal" class="modal-overlay">
        <div class="modal-container">
            <div class="modal-header">
                <h2 id="modal-title">Edit Content</h2>
                <div class="close-modal" onclick="closeEditModal()">
                    <i class="fas fa-times"></i>
                </div>
            </div>
            <div class="modal-body" id="modal-content">
                <!-- Dynamic form injected via JS -->
            </div>
        </div>
    </div>

    <!-- LOGIN SECTION -->
    <div id="login-section">
        <form id="login-form">
            <h2>Admin Login</h2>
            <div class="form-group">
                <input type="password" id="password" placeholder="Enter Secure Password" required>
            </div>
            <button type="submit">Unlock Dashboard <i class="fas fa-lock-open"></i></button>
        </form>
    </div>

    <!-- DASHBOARD SECTION -->
    <div id="admin-dashboard" class="admin-wrapper" style="display:none;">

        <!-- SIDEBAR -->
        <aside class="sidebar">
            <div class="sidebar-header">
                <img src="/favicon.png" alt="Logo" style="width: 40px; margin-bottom: 10px;">
                <div>Admin Panel</div>
            </div>
            <nav class="sidebar-nav">
                <button class="sidebar-button active" data-tab="tab-dashboard">
                    <i class="fas fa-chart-line"></i> <span>Dashboard</span>
                </button>
                <button class="sidebar-button" data-tab="tab-shloka">
                    <i class="fas fa-book-open"></i> <span>Shlokas</span>
                </button>
                <button class="sidebar-button" data-tab="tab-courses">
                    <i class="fas fa-graduation-cap"></i> <span>Courses</span>
                </button>
                <button class="sidebar-button" data-tab="tab-quizzes">
                    <i class="fas fa-vial"></i> <span>Quizzes</span>
                </button>
                <button class="sidebar-button" data-tab="tab-certificates">
                    <i class="fas fa-certificate"></i> <span>Certificates</span>
                </button>
                <button class="sidebar-button" data-tab="tab-testimonials">
                    <i class="fas fa-comment-dots"></i> <span>Testimonials</span>
                </button>
                <button class="sidebar-button" data-tab="tab-blog">
                    <i class="fas fa-pen-nib"></i> <span>Blog</span>
                </button>
                <button class="sidebar-button" data-tab="tab-artwork">
                    <i class="fas fa-palette"></i> <span>Artwork</span>
                </button>
                <button class="sidebar-button" data-tab="tab-students">
                    <i class="fas fa-users"></i> <span>Students</span>
                </button>
                <button class="sidebar-button" data-tab="tab-analytics">
                    <i class="fas fa-chart-pie"></i> <span>Analytics</span>
                </button>
                <button class="sidebar-button" data-tab="tab-about">
                    <i class="fas fa-cog"></i> <span>Site Settings</span>
                </button>
            </nav>
        </aside>

        <!-- MAIN CONTENT AREA -->
        <main class="main-content">

            <!-- TAB: DASHBOARD -->
            <div id="tab-dashboard" class="content-page active">
                <h1><i class="fas fa-tachometer-alt"></i> Dashboard Overview</h1>

                <div class="dashboard-stats">
                    <div class="stat-card">
                        <h3>Shlokas</h3><span id="stat-shlokas" class="stat-number">0</span>
                    </div>
                    <div class="stat-card">
                        <h3>Total Likes</h3><span id="stat-likes" class="stat-number">0</span>
                    </div>
                    <div class="stat-card">
                        <h3>Students</h3><span id="stat-students" class="stat-number">0</span>
                    </div>
                    <div class="stat-card">
                        <h3>Subscribers</h3><span id="stat-subscribers" class="stat-number">0</span>
                    </div>
                    <div class="stat-card">
                        <h3>Artworks</h3><span id="stat-artwork" class="stat-number">0</span>
                    </div>
                    <div class="stat-card">
                        <h3>Courses Active</h3><span id="stat-courses" class="stat-number">0</span>
                    </div>
                    <div class="stat-card" style="border-left: 5px solid var(--warning);">
                        <h3>Certificates (Pending)</h3><span id="stat-certificates" class="stat-number">0</span>
                    </div>
                    <div class="stat-card" style="border-left: 5px solid #9c27b0;">
                        <h3>Testimonials (Pending)</h3><span id="stat-pending-testimonials" class="stat-number">0</span>
                    </div>
                </div>

                <div class="dashboard-charts">
                    <div class="chart-card">
                        <h3>Certificates Status</h3><canvas id="certStatusChart"></canvas>
                    </div>
                    <div class="chart-card">
                        <h3>Certificates by Course</h3><canvas id="certCourseChart"></canvas>
                    </div>
                </div>

                <div class="dashboard-activity">
                    <div class="activity-card">
                        <h3>Recent Certificates</h3>
                        <ul id="recent-certificates"></ul>
                    </div>
                    <div class="activity-card">
                        <h3>Recent Testimonials</h3>
                        <ul id="recent-testimonials"></ul>
                    </div>
                </div>
            </div>

            <!-- TAB: SHLOKAS -->
            <div id="tab-shloka" class="content-page">
                <h1>Manage Shlokas</h1>
                <form id="shloka-form">
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                        <input type="number" id="adhyay" placeholder="Adhyay" required>
                        <input type="number" id="shloka" placeholder="Shloka" required>
                    </div>
                    <input id="video_url" placeholder="YouTube Video ID">
                    <select id="shloka-course-select">
                        <option value="">Add to Course (optional)</option>
                    </select>
                    <textarea id="text" placeholder="Shloka translation..."></textarea>
                    <button type="submit">Add New Shloka <i class="fas fa-plus"></i></button>
                </form>
                <div class="admin-item-list" id="shloka-list-admin"></div>
            </div>

            <!-- TAB: COURSES -->
            <div id="tab-courses" class="content-page">
                <h1>Manage Courses</h1>
                <button id="show-course-form" class="primary-btn" style="margin-bottom: 20px;">+ Create Course</button>
                <div id="course-form-wrapper" style="display:none;">
                    <form id="course-form">
                        <input id="course-title" placeholder="Course Title" required>
                        <select id="course-adhyay" required></select>
                        <input id="course-image-url" placeholder="Course Image URL">
                        <textarea id="course-description" placeholder="Description..."></textarea>
                        <div id="course-shloka-list"
                            style="max-height: 200px; overflow-y: auto; border: 1px solid var(--border); padding: 10px; border-radius: 8px; margin: 10px 0;">
                        </div>
                        <button type="submit">Launch Course <i class="fas fa-rocket"></i></button>
                    </form>
                </div>
                <div class="admin-item-list" id="course-list"></div>
            </div>

            <!-- TAB: QUIZZES -->
            <div id="tab-quizzes" class="content-page">
                <h1>Manage Quizzes</h1>
                <div class="stat-card" style="margin-bottom:30px;">
                    <label>Pass Percentage</label>
                    <select id="quiz-course"></select>
                    <input type="number" id="quiz-pass" value="50">
                </div>
                <div id="quiz-questions"></div>
                <div style="display:flex; gap:15px; margin-top:20px;">
                    <button id="add-question" style="background:var(--secondary-gradient); color:white;">+ Add
                        Question</button>
                    <button id="quiz-save" class="primary-btn">Save Complete Quiz</button>
                </div>
                <h2 style="margin:30px 0 15px;">Active Quizzes</h2>
                <div class="admin-item-list" id="quiz-list"></div>
            </div>

            <!-- TAB: CERTIFICATES -->
            <div id="tab-certificates" class="content-page">
                <h1>Certificates</h1>
                <div class="stat-card" style="margin-bottom:30px; border-left:5px solid var(--secondary);">
                    <h3>Issue Automated Certificate</h3>
                    <form id="manual-cert-form" style="box-shadow:none; border:none; padding:0;">
                        <div style="display:grid; grid-template-columns: 1fr 1fr; gap:15px; margin-bottom:15px;">
                            <select id="mc-student" required>
                                <option value="">Select Student</option>
                            </select>
                            <select id="mc-course" required>
                                <option value="">Select Enrolled Course</option>
                            </select>
                            <input id="mc-percentage" type="number" placeholder="Percentage % (Optional)">
                            <select id="mc-lang">
                                <option value="hi">Hindi</option>
                                <option value="en">English</option>
                            </select>
                            <input id="mc-cert-id" placeholder="Certificate ID" readonly>
                        </div>
                        <button type="submit">Issue Certificate Immediately <i class="fas fa-check-circle"></i></button>
                    </form>
                </div>

                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 30px;">
                    <div id="certificate-pending">
                        <h3>Pending Approvals</h3>
                    </div>
                    <div id="certificate-approved">
                        <h3>Approved History</h3>
                    </div>
                </div>
            </div>

            <!-- TAB: TESTIMONIALS -->
            <div id="tab-testimonials" class="content-page">
                <h1>Testimonials</h1>
                <form id="testimonial-form">
                    <input id="testimonial-author" placeholder="Author Name" required>
                    <textarea id="testimonial-quote" placeholder="Testimonial..." required></textarea>
                    <button type="submit">Add Approved Testimonial</button>
                </form>
                <div id="testimonial-list-pending"></div>
                <div id="testimonial-list-approved"></div>
            </div>

            <!-- TAB: BLOG -->
            <div id="tab-blog" class="content-page">
                <h1>Blog Posts</h1>
                <form id="blog-form">
                    <input id="blog-title" placeholder="Post Title" required>
                    <textarea id="blog-content" placeholder="Content..."></textarea>
                    <button type="submit">Publish Blog</button>
                </form>
                <div class="admin-item-list" id="blog-list-admin"></div>
            </div>

            <!-- TAB: STUDENTS -->
            <div id="tab-students" class="content-page">
                <h1>Registered Students</h1>
                <div class="stat-card" style="margin-bottom:20px;">
                    <h3>User Limit Management</h3>
                    <p style="color:var(--text-muted); margin-bottom:10px;">View and update `used_today` / `daily_limit` for each user.</p>
                </div>
                <div class="admin-item-list" id="student-list"></div>
            </div>

            <div id="tab-analytics" class="content-page">
                <h1>Usage Analytics</h1>
                <div id="analytics-overview" style="display:grid; grid-template-columns:repeat(4,minmax(160px,1fr)); gap:12px; margin-bottom:20px;"></div>
                <div class="stat-card" style="margin-bottom:20px;">
                    <h3>Student-wise</h3>
                    <div style="display:flex; gap:8px; margin-bottom:10px;">
                        <input id="analytics-search" placeholder="Search student..." style="max-width:260px;">
                        <select id="analytics-sort" style="max-width:240px;">
                            <option value="ai_used_today">Sort: AI Used Today</option>
                            <option value="course_completion_percent">Sort: Completion %</option>
                            <option value="shlok_views">Sort: Shlok Views</option>
                        </select>
                    </div>
                    <div id="analytics-student"></div>
                </div>
                <div class="stat-card" style="margin-bottom:20px;">
                    <h3>Shlok-wise</h3>
                    <div id="analytics-shlok"></div>
                </div>
                <div class="stat-card">
                    <h3>Course-wise</h3>
                    <div id="analytics-course"></div>
                </div>
            </div>

            <!-- TAB: ARTWORK -->
            <div id="tab-artwork" class="content-page">
                <h1>Artwork Gallery</h1>
                <form id="artwork-form">
                    <input id="artwork-title" placeholder="Artwork Name" required>
                    <input id="artwork-url" placeholder="Image URL" required>
                    <button type="submit">Add Artwork</button>
                </form>
                <div class="admin-item-list" id="artwork-list"></div>
            </div>

            <!-- TAB: SITE SETTINGS -->
            <div id="tab-about" class="content-page">
                <h1>Site Settings</h1>
                <div class="stat-card" style="margin-bottom:30px; border-left:5px solid var(--primary);">
                    <h3>Global Branding</h3>
                    <form id="settings-form" style="box-shadow:none; border:none; padding:0;">
                        <input id="set-logo-url" placeholder="Logo Image URL">
                        <input id="set-about-img-url" placeholder="About Aaradhya Photo URL">
                        <textarea id="set-about-text" placeholder="About Gitadhya content..."
                            style="height:100px;"></textarea>

                        <h4 style="margin:15px 0;">Social & Personal Links</h4>
                        <div style="display:grid; grid-template-columns:1fr 1fr; gap:10px;">
                            <input id="soc-instagram" placeholder="Instagram URL">
                            <input id="soc-youtube" placeholder="YouTube URL">
                            <input id="soc-twitter" placeholder="Twitter/X URL">
                            <input id="soc-facebook" placeholder="Facebook URL">
                            <input id="set-personal-link" placeholder="Personal Link/Portfolio URL">
                            <input id="set-personal-link-logo" placeholder="Personal Link Logo/Icon URL">
                        </div>
                        <h4 style="margin:15px 0 8px;">Course Progress Controls</h4>
                        <div id="adhyay-totals-grid"
                            style="display:grid; grid-template-columns:repeat(3, 1fr); gap:10px; margin-bottom:15px;">
                        </div>
                        <div id="course-status-list"
                            style="display:grid; grid-template-columns:1fr; gap:10px; margin-bottom:15px;"></div>
                        <button type="submit" style="margin-top:20px;">Save All Settings</button>
                    </form>
                </div>

                <div class="stat-card" style="margin-bottom:30px; border-left:5px solid var(--primary);">
                    <h3>Send Broadcast Push</h3>
                    <form id="push-form" style="box-shadow:none; border:none; padding:0;">
                        <input id="push-title" placeholder="Title" required>
                        <textarea id="push-body" placeholder="Message..." required></textarea>
                        <input id="push-url" placeholder="Deep link URL (e.g. /course/karma-yoga)">
                        <button type="submit">Broadcast Now <i class="fas fa-broadcast-tower"></i></button>
                    </form>
                </div>
            </div>

        </main>
    </div>

    <!-- SCRIPTS -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', () => {

            let adminPassword = '';
            let settingsCache = {};
            let coursesCache = [];
            let studentsDetailedCache = [];

            /* --- UI HELPERS --- */
            window.showToast = (msg, type = 'info') => {
                const container = document.getElementById('toast-container');
                const t = document.createElement('div');
                t.className = `toast ${type}`;
                t.innerHTML = `<i class="fas fa-${type === 'success' ? 'check-circle' : 'info-circle'}"></i> <span>${msg}</span>`;
                container.appendChild(t);
                setTimeout(() => { t.classList.add('fade-out'); setTimeout(() => t.remove(), 500); }, 4000);
            };

            function showAutoPushToast(autoPush, label = 'Auto push') {
                if (!autoPush) return;
                const sent = Number(autoPush.sent || 0);
                const failed = Number(autoPush.failed || 0);
                const removed = Number(autoPush.removed || 0);

                if (sent === 0 && failed === 0 && removed === 0) {
                    showToast(`${label}: no subscribers yet.`, 'info');
                    return;
                }

                const parts = [];
                if (sent) parts.push(`sent to ${sent}`);
                if (failed) parts.push(`${failed} failed`);
                if (removed) parts.push(`${removed} removed`);

                const type = failed ? 'error' : 'success';
                showToast(`${label} ${parts.join(', ')}.`, type);
            }

            window.openEditModal = (title, html) => {
                document.getElementById('modal-title').innerText = title;
                document.getElementById('modal-content').innerHTML = html;
                document.getElementById('edit-modal').classList.add('active');
            };

            window.closeEditModal = () => {
                document.getElementById('edit-modal').classList.remove('active');
            };

            function renderAdhyayTotalsGrid(data = {}) {
                const grid = document.getElementById('adhyay-totals-grid');
                if (!grid) return;
                grid.innerHTML = '';
                for (let i = 1; i <= 18; i++) {
                    const val = data[i] || '';
                    const cell = document.createElement('div');
                    cell.innerHTML = `
                        <label style="font-weight:600; font-size:0.9rem;">Adhyay ${i}</label>
                        <input type="number" min="0" id="adhyay-total-${i}" placeholder="Total Shlokas"
                            value="${val}">
                    `;
                    grid.appendChild(cell);
                }
            }

            function renderCourseStatusOverrides() {
                const box = document.getElementById('course-status-list');
                if (!box) return;
                box.innerHTML = '';
                if (!coursesCache.length) {
                    box.innerHTML = '<div style="color:var(--text-muted);">No courses found yet.</div>';
                    return;
                }
                const overrides = settingsCache.courseStatusOverrides || {};
                coursesCache.forEach(c => {
                    const row = document.createElement('div');
                    row.style = 'display:grid; grid-template-columns:1fr 180px; gap:10px; align-items:center;';
                    row.innerHTML = `
                        <div><strong>${c.title}</strong> <span style="color:var(--text-muted);">(Adhyay ${c.adhyay})</span></div>
                        <select data-course-id="${c._id}">
                            <option value="">Auto</option>
                            <option value="running">Currently Running</option>
                            <option value="completed">Completed</option>
                        </select>
                    `;
                    const sel = row.querySelector('select');
                    if (overrides && overrides[c._id]) sel.value = overrides[c._id];
                    box.appendChild(row);
                });
            }

            function renderShlokaCourseSelect() {
                const sel = document.getElementById('shloka-course-select');
                if (!sel) return;
                sel.innerHTML = '<option value="">Add to Course (optional)</option>';
                coursesCache.forEach(c => {
                    const opt = document.createElement('option');
                    opt.value = c._id;
                    opt.textContent = `${c.title} (Adhyay ${c.adhyay})`;
                    sel.appendChild(opt);
                });
            }

            /* --- LOGIN --- */
            document.getElementById('login-form').onsubmit = async (e) => {
                e.preventDefault();
                const password = document.getElementById('password').value;
                const r = await fetch('/api/login', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ password }) });
                const d = await r.json();
                if (!d.success) return showToast('Invalid Credentials!', 'error');
                adminPassword = password;
                document.getElementById('login-section').style.display = 'none';
                document.getElementById('admin-dashboard').style.display = 'flex';
                loadDashboard();
                loadAllData();
            };

            function loadAllData() {
                loadShlokasAdmin(); loadCoursesAdmin(); loadQuizzes(); loadCertificates();
                loadTestimonials(); loadBlogPosts(); loadArtwork(); loadSiteSettings();
                loadAdhyayForCourses(); loadCoursesForQuiz(); loadStudentsV2(); loadAnalytics();
                loadCertificateFormStudents();
            }

            /* --- TAB SWITCHING --- */
            document.querySelectorAll('.sidebar-button').forEach(btn => {
                btn.onclick = () => {
                    document.querySelectorAll('.sidebar-button').forEach(b => b.classList.remove('active'));
                    document.querySelectorAll('.content-page').forEach(p => p.classList.remove('active'));
                    btn.classList.add('active');
                    document.getElementById(btn.dataset.tab).classList.add('active');
                };
            });

            /* --- DASHBOARD LOGIC --- */
            async function loadDashboard() {
                try {
                    const statsRes = await fetch('/api/admin/stats');
                    const statsData = await statsRes.json();

                    if (statsData.stats) {
                        statsData.stats.forEach(s => {
                            if (s.label === 'Total Shlokas') document.getElementById('stat-shlokas').textContent = s.value;
                            if (s.label === 'Enrolled Students') document.getElementById('stat-students').textContent = s.value;
                            if (s.label === 'Total Likes ❤️') document.getElementById('stat-likes').textContent = s.value;
                            if (s.label === 'Courses Active') document.getElementById('stat-courses').textContent = s.value;
                            if (s.label === 'Artworks') document.getElementById('stat-artwork').textContent = s.value;
                        });
                    }

                    const pushRes = await fetch('/api/push/count');
                    const pushData = await pushRes.json();
                    document.getElementById('stat-subscribers').textContent = pushData.count || 0;

                    const certsRes = await fetch('/api/certificates');
                    const certs = await certsRes.json();
                    document.getElementById('stat-certificates').textContent = certs.filter(c => c.status === 'pending').length;

                    const testimonialsRes = await fetch('/api/testimonials/all');
                    const testimonials = await testimonialsRes.json();
                    document.getElementById('stat-pending-testimonials').textContent = testimonials.filter(t => t.status === 'pending').length;

                    renderCharts(certs);
                } catch (e) { console.error(e); }
            }

            function renderCharts(certs) {
                const old1 = Chart.getChart("certStatusChart"); if (old1) old1.destroy();
                const old2 = Chart.getChart("certCourseChart"); if (old2) old2.destroy();

                const app = certs.filter(c => c.status === 'approved').length;
                const pen = certs.filter(c => c.status === 'pending').length;

                new Chart(document.getElementById('certStatusChart'), {
                    type: 'doughnut', data: { labels: ['Approved', 'Pending'], datasets: [{ data: [app, pen], backgroundColor: ['#10b981', '#f59e0b'] }] },
                    options: { cutout: '70%', plugins: { legend: { position: 'bottom' } } }
                });

                const map = {}; certs.forEach(c => map[c.courseTitle] = (map[c.courseTitle] || 0) + 1);
                new Chart(document.getElementById('certCourseChart'), {
                    type: 'bar', data: { labels: Object.keys(map), datasets: [{ label: 'Issued', data: Object.values(map), backgroundColor: '#3b82f6' }] }
                });
            }

            /* --- SHLOKA MODAL EDIT --- */
            window.loadShlokasAdmin = async () => {
                const r = await fetch('/api/shlokas');
                const list = await r.json();
                const box = document.getElementById('shloka-list-admin'); box.innerHTML = '';
                if (!Array.isArray(list) || list.length === 0) {
                    box.innerHTML = '<div style="color:var(--text-muted);">No shlokas found yet.</div>';
                    return;
                }

                const grouped = {};
                list.forEach(s => {
                    const key = Number(s.adhyay) || 0;
                    if (!grouped[key]) grouped[key] = [];
                    grouped[key].push(s);
                });

                Object.keys(grouped).sort((a, b) => a - b).forEach(adhyay => {
                    const group = document.createElement('details');
                    group.open = true;
                    group.style.marginBottom = '16px';
                    group.style.border = '1px solid var(--border)';
                    group.style.borderRadius = '12px';
                    group.style.background = '#fff';
                    group.innerHTML = `
                        <summary style="cursor:pointer; padding:12px 16px; font-weight:800; background:#fafafa; border-bottom:1px solid var(--border);">
                            Adhyay ${adhyay} <span style="color:var(--text-muted); font-weight:600;">(${grouped[adhyay].length})</span>
                        </summary>
                    `;
                    grouped[adhyay]
                        .sort((x, y) => x.shloka - y.shloka)
                        .forEach(s => {
                            const div = document.createElement('div');
                            div.className = 'shloka-admin-item';
                            div.innerHTML = `<div><strong>Shloka ${s.shloka}</strong></div>
                                <div class="admin-buttons">
                                    <button class="edit-button" onclick='showEditShlokaModal(${JSON.stringify(s)})'><i class="fas fa-edit"></i> Edit</button>
                                    <button class="delete-button" onclick="deleteShloka('${s._id}')">Delete</button>
                                </div>`;
                            group.appendChild(div);
                        });
                    box.appendChild(group);
                });
            };

            window.showEditShlokaModal = (s) => {
                const html = `
                    <form id="modal-edit-shloka">
                        <div style="display:grid; grid-template-columns:1fr 1fr; gap:15px;">
                            <input type="number" id="m-adhyay" value="${s.adhyay}" required>
                            <input type="number" id="m-shloka" value="${s.shloka}" required>
                        </div>
                        <input id="m-video" value="${s.video_id || ''}" placeholder="Video ID">
                        <textarea id="m-text" style="height:150px;">${s.text || ''}</textarea>
                        <button type="submit" class="primary-btn">Update Shloka</button>
                    </form>`;
                openEditModal('Update Shloka', html);
                document.getElementById('modal-edit-shloka').onsubmit = async e => {
                    e.preventDefault();
                    await fetch(`/api/shlokas/${s._id}`, {
                        method: 'PUT', headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ adhyay: document.getElementById('m-adhyay').value, shloka: document.getElementById('m-shloka').value, text: document.getElementById('m-text').value, video_id: document.getElementById('m-video').value, password: adminPassword })
                    });
                    showToast('Shloka Updated!', 'success'); closeEditModal(); loadShlokasAdmin();
                };
            };

            document.getElementById('shloka-form').onsubmit = async e => {
                e.preventDefault();
                const addRes = await fetch('/api/shlokas', {
                    method: 'POST', headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ adhyay: Number(document.getElementById('adhyay').value), shloka: Number(document.getElementById('shloka').value), text: document.getElementById('text').value, video_id: document.getElementById('video_url').value, password: adminPassword })
                });
                const newShloka = await addRes.json();
                if (addRes.ok) {
                    const courseId = document.getElementById('shloka-course-select').value;
                    if (courseId && newShloka && newShloka._id) {
                        try {
                            const cr = await fetch(`/api/courses/${courseId}`);
                            const course = await cr.json();
                            const existing = Array.isArray(course.shlokas) ? course.shlokas.map(s => s._id || s) : [];
                            const updatedShlokas = [...new Set([...existing, newShloka._id])];
                            await fetch(`/api/courses/${courseId}`, {
                                method: 'PUT', headers: { 'Content-Type': 'application/json' },
                                body: JSON.stringify({
                                    title: course.title,
                                    description: course.description,
                                    adhyay: course.adhyay,
                                    shlokas: updatedShlokas,
                                    imageUrl: course.imageUrl,
                                    password: adminPassword
                                })
                            });
                            showToast('Shloka added to course!', 'success');
                        } catch (err) {
                            showToast('Course update failed', 'error');
                        }
                    }
                    showAutoPushToast(newShloka.autoPush, 'Auto push');
                    showToast('Shloka Added!', 'success'); loadShlokasAdmin(); e.target.reset();
                } else {
                    showToast(newShloka.message || 'Shloka add failed', 'error');
                }
            };

            window.deleteShloka = async id => { if (confirm('Delete?')) { await fetch('/api/shlokas/' + id, { method: 'DELETE', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ password: adminPassword }) }); loadShlokasAdmin(); } };

            /* --- COURSE MODAL EDIT --- */
            window.loadCoursesAdmin = async () => {
                const r = await fetch('/api/courses');
                const list = await r.json();
                coursesCache = Array.isArray(list) ? list : [];
                const box = document.getElementById('course-list'); box.innerHTML = '';
                list.forEach(c => {
                    const div = document.createElement('div'); div.className = 'shloka-admin-item';
                    div.innerHTML = `<div><strong>${c.title}</strong></div>
                        <div class="admin-buttons">
                            <button class="edit-button" onclick="showEditCourseModal('${c._id}')">Edit</button>
                            <button class="delete-button" onclick="deleteCourse('${c._id}')">Delete</button>
                        </div>`;
                    box.appendChild(div);
                });
                renderCourseStatusOverrides();
                renderShlokaCourseSelect();
            };

            window.showEditCourseModal = async id => {
                const r = await fetch('/api/courses'); const courses = await r.json(); const c = courses.find(x => x._id === id);
                const shR = await fetch('/api/shlokas'); const allS = await shR.json();
                let checks = allS.filter(s => s.adhyay == c.adhyay).map(s => `<label style="display:block; margin:5px 0;"><input type="checkbox" value="${s._id}" ${c.shlokas.some(cs => cs._id === s._id) ? 'checked' : ''}> Shloka ${s.shloka}</label>`).join('');
                const html = `
                    <form id="modal-edit-course">
                        <input id="me-title" value="${c.title}" required>
                        <input id="me-image-url" value="${c.imageUrl || ''}" placeholder="Course Image URL">
                        <textarea id="me-desc">${c.description || ''}</textarea>
                        <div style="max-height:150px; overflow-y:auto; border:1px solid #ddd; padding:10px; border-radius:8px;">${checks}</div>
                        <button type="submit" class="primary-btn" style="margin-top:15px;">Update Course</button>
                    </form>`;
                openEditModal('Update Course', html);
                document.getElementById('modal-edit-course').onsubmit = async e => {
                    e.preventDefault();
                    const sel = Array.from(e.target.querySelectorAll('input:checked')).map(cb => cb.value);
                    await fetch(`/api/courses/${id}`, {
                        method: 'PUT', headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ title: document.getElementById('me-title').value, imageUrl: document.getElementById('me-image-url').value, description: document.getElementById('me-desc').value, shlokas: sel, adhyay: c.adhyay, password: adminPassword })
                    });
                    showToast('Course Updated!', 'success'); closeEditModal(); loadCoursesAdmin();
                };
            };

            document.getElementById('show-course-form').onclick = () => { const w = document.getElementById('course-form-wrapper'); w.style.display = w.style.display === 'none' ? 'block' : 'none'; };

            document.getElementById('course-form').onsubmit = async e => {
                e.preventDefault();
                const sel = Array.from(document.querySelectorAll('#course-shloka-list input:checked')).map(cb => cb.value);
                const r = await fetch('/api/courses', {
                    method: 'POST', headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ title: document.getElementById('course-title').value, adhyay: document.getElementById('course-adhyay').value, imageUrl: document.getElementById('course-image-url').value, description: document.getElementById('course-description').value, shlokas: sel, password: adminPassword })
                });
                const d = await r.json();
                if (r.ok) {
                    showAutoPushToast(d.autoPush, 'Auto push');
                    showToast('Course Created!', 'success'); loadCoursesAdmin(); e.target.reset(); document.getElementById('course-form-wrapper').style.display = 'none';
                } else {
                    showToast(d.message || 'Course create failed', 'error');
                }
            };

            window.deleteCourse = async id => { if (confirm('Delete Course?')) { await fetch('/api/courses/' + id, { method: 'DELETE', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ password: adminPassword }) }); loadCoursesAdmin(); } };

            /* --- BLOG MODAL EDIT --- */
            window.loadBlogPosts = async () => {
                const r = await fetch('/api/blog');
                const list = await r.json();
                const box = document.getElementById('blog-list-admin'); box.innerHTML = '';
                list.forEach(p => {
                    const div = document.createElement('div'); div.className = 'shloka-admin-item';
                    div.innerHTML = `<div><strong>${p.title}</strong></div>
                        <div class="admin-buttons">
                            <button class="edit-button" onclick='showEditBlogModal(${JSON.stringify(p)})'>Edit</button>
                            <button class="delete-button" onclick="deleteBlog('${p._id}')">Delete</button>
                        </div>`;
                    box.appendChild(div);
                });
            };

            window.showEditBlogModal = p => {
                const html = `<form id="m-eb-form"><input id="me-bt" value="${p.title}" required><textarea id="me-bc" style="height:250px;">${p.content || ''}</textarea><button type="submit" class="primary-btn">Update Post</button></form>`;
                openEditModal('Edit Blog Post', html);
                document.getElementById('m-eb-form').onsubmit = async e => {
                    e.preventDefault();
                    await fetch(`/api/blog/${p._id}`, { method: 'PUT', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ title: document.getElementById('me-bt').value, content: document.getElementById('me-bc').value, password: adminPassword }) });
                    showToast('Blog Updated!', 'success'); closeEditModal(); loadBlogPosts();
                };
            };

            document.getElementById('blog-form').onsubmit = async e => {
                e.preventDefault();
                const r = await fetch('/api/blog', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ title: document.getElementById('blog-title').value, content: document.getElementById('blog-content').value, password: adminPassword }) });
                const d = await r.json();
                if (r.ok) {
                    showAutoPushToast(d.autoPush, 'Auto push');
                    showToast('Blog Published!', 'success'); loadBlogPosts(); e.target.reset();
                } else {
                    showToast(d.message || 'Blog publish failed', 'error');
                }
            };

            window.deleteBlog = async id => { if (confirm('Delete?')) { await fetch('/api/blog/' + id, { method: 'DELETE', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ password: adminPassword }) }); loadBlogPosts(); } };

            /* --- ARTWORK MODAL EDIT --- */
            window.loadArtwork = async () => {
                const r = await fetch('/api/artwork');
                const list = await r.json();
                const box = document.getElementById('artwork-list'); box.innerHTML = '';
                list.forEach(a => {
                    const div = document.createElement('div'); div.className = 'shloka-admin-item';
                    div.innerHTML = `<img src="${a.imageUrl}" style="width:50px; border-radius:8px; margin-right:15px;"> <strong>${a.title}</strong>
                        <div class="admin-buttons">
                            <button class="edit-button" onclick='showEditArtModal(${JSON.stringify(a)})'>Edit</button>
                            <button class="delete-button" onclick="deleteArt('${a._id}')">Delete</button>
                        </div>`;
                    box.appendChild(div);
                });
            };

            window.showEditArtModal = a => {
                const html = `<form id="m-ea-form"><input id="me-at" value="${a.title}" required><input id="me-au" value="${a.imageUrl}" required><button type="submit" class="primary-btn">Update Artwork</button></form>`;
                openEditModal('Edit Artwork', html);
                document.getElementById('m-ea-form').onsubmit = async e => {
                    e.preventDefault();
                    await fetch(`/api/artwork/${a._id}`, { method: 'PUT', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ title: document.getElementById('me-at').value, imageUrl: document.getElementById('me-au').value, password: adminPassword }) });
                    showToast('Artwork Updated!', 'success'); closeEditModal(); loadArtwork();
                };
            };

            document.getElementById('artwork-form').onsubmit = async e => {
                e.preventDefault();
                const r = await fetch('/api/artwork', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ title: document.getElementById('artwork-title').value, imageUrl: document.getElementById('artwork-url').value, password: adminPassword }) });
                const d = await r.json();
                if (r.ok) {
                    showAutoPushToast(d.autoPush, 'Auto push');
                    showToast('Artwork Added!', 'success'); loadArtwork(); e.target.reset();
                } else {
                    showToast(d.message || 'Artwork add failed', 'error');
                }
            };

            window.deleteArt = async id => { if (confirm('Delete?')) { await fetch('/api/artwork/' + id, { method: 'DELETE', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ password: adminPassword }) }); loadArtwork(); } };

            /* --- CERTIFICATES --- */
            window.loadCertificates = async () => {
                const r = await fetch('/api/certificates'); const list = await r.json();
                const p = document.getElementById('certificate-pending'); const a = document.getElementById('certificate-approved');
                p.innerHTML = '<h3>Pending Approvals</h3>'; a.innerHTML = '<h3>Approved History</h3>';
                list.forEach(c => {
                    const div = document.createElement('div'); div.className = 'shloka-admin-item';
                    div.innerHTML = `<div><strong>${c.name}</strong><br><small>${c.courseTitle}</small></div>
                        <div class="admin-buttons">
                            ${c.status === 'pending' ? `<button class="approve-button" onclick="approveCert('${c._id}')">Approve</button>` : `<button class="edit-button" onclick="window.open('/api/certificate?name=${encodeURIComponent(c.name)}&mobile=${c.mobile}&courseTitle=${encodeURIComponent(c.courseTitle)}&lang=${c.language || 'hi'}', '_blank')">View</button>`}
                            <button class="delete-button" onclick="deleteCert('${c._id}')">Delete</button>
                        </div>`;
                    (c.status === 'pending' ? p : a).appendChild(div);
                });
            };
            window.approveCert = async id => { await fetch('/api/certificates/approve/' + id, { method: 'PUT' }); loadCertificates(); showToast('Approved!', 'success'); };
            window.deleteCert = async id => { if (confirm('Delete?')) { await fetch('/api/certificates/' + id, { method: 'DELETE' }); loadCertificates(); } };

            document.getElementById('mc-student').onchange = (e) => {
                loadCertificateCoursesForStudent(e.target.value);
            };
            document.getElementById('mc-course').onchange = () => {
                const studentId = document.getElementById('mc-student').value;
                const courseTitle = document.getElementById('mc-course').value;
                const certIdInput = document.getElementById('mc-cert-id');
                const student = studentsDetailedCache.find((s) => s._id === studentId);
                certIdInput.value = student && courseTitle ? makeCertificateId(courseTitle, student.mobile) : '';
            };

            document.getElementById('manual-cert-form').onsubmit = async e => {
                e.preventDefault();
                try {
                    const studentId = document.getElementById('mc-student').value;
                    const courseTitle = document.getElementById('mc-course').value;
                    const student = studentsDetailedCache.find((s) => s._id === studentId);
                    if (!student || !courseTitle) {
                        return showToast('Select student and enrolled course', 'error');
                    }
                    const r = await fetch('/api/certificates/create', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            studentId,
                            name: student.name,
                            mobile: student.mobile,
                            courseTitle,
                            percentage: document.getElementById('mc-percentage').value,
                            language: document.getElementById('mc-lang').value,
                            certificateId: document.getElementById('mc-cert-id').value,
                            password: adminPassword
                        })
                    });
                    const d = await r.json();
                    if (d.success) {
                        showToast('Certificate Issued Successfully!', 'success');
                        loadCertificates();
                        e.target.reset();
                    } else {
                        showToast(d.message || 'Failed to issue certificate', 'error');
                    }
                } catch (err) {
                    showToast('Error issuing certificate', 'error');
                }
            };

            /* --- QUIZZES --- */
            async function loadQuizzes() {
                const r = await fetch('/api/quiz'); const list = await r.json();
                const box = document.getElementById('quiz-list'); box.innerHTML = '';
                list.forEach(q => {
                    const div = document.createElement('div'); div.className = 'shloka-admin-item';
                    div.innerHTML = `<div><strong>${q.course?.title || 'Unknown Course'}</strong></div>
                        <button class="delete-button" onclick="deleteQuiz('${q._id}')">Delete</button>`;
                    box.appendChild(div);
                });
            }
            window.deleteQuiz = async id => { if (confirm('Delete Quiz?')) { await fetch('/api/quiz/' + id, { method: 'DELETE', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ password: adminPassword }) }); loadQuizzes(); } };

            document.getElementById('add-question').onclick = () => {
                const d = document.createElement('div'); d.className = 'stat-card'; d.style.background = '#f8fafc'; d.style.marginTop = '10px';
                d.innerHTML = `<input placeholder="Question" required><div style="display:grid; grid-template-columns:1fr 1fr; gap:10px; margin-top:10px;"><input placeholder="Option A"><input placeholder="Option B"><input placeholder="Option C"><input placeholder="Option D"></div><input type="number" placeholder="Correct Index (0-3)" style="margin-top:10px;"><button type="button" onclick="this.parentElement.remove()" style="background:var(--error); margin-top:10px;">Remove</button>`;
                document.getElementById('quiz-questions').appendChild(d);
            };

            document.getElementById('quiz-save').onclick = async () => {
                const qs = Array.from(document.querySelectorAll('#quiz-questions .stat-card')).map(d => {
                    const inps = d.querySelectorAll('input');
                    return { question: inps[0].value, options: [inps[1].value, inps[2].value, inps[3].value, inps[4].value], correctIndex: parseInt(inps[5].value) };
                });
                await fetch('/api/quiz', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ course: document.getElementById('quiz-course').value, passPercentage: document.getElementById('quiz-pass').value, questions: qs, password: adminPassword }) });
                showToast('Quiz Saved!', 'success'); loadQuizzes(); document.getElementById('quiz-questions').innerHTML = '';
            };

            /* --- TESTIMONIALS --- */
            window.loadTestimonials = async () => {
                const r = await fetch('/api/testimonials/all'); const list = await r.json();
                const p = document.getElementById('testimonial-list-pending'); const a = document.getElementById('testimonial-list-approved');
                p.innerHTML = '<h3>Pending</h3>'; a.innerHTML = '<h3>Approved</h3>';
                list.forEach(t => {
                    const div = document.createElement('div'); div.className = 'shloka-admin-item';
                    div.innerHTML = `
                        <div style="flex:1;">
                            <strong>${t.author}</strong>
                            <p style="font-size:0.85rem; color:var(--text-muted); margin-top:5px;">${t.quote.substring(0, 100)}...</p>
                        </div>
                        <div class="admin-buttons">
                            ${t.status === 'pending' ? `<button class="approve-button" onclick="approveTest('${t._id}')">Approve</button>` : ''}
                            <button class="delete-button" onclick="deleteTest('${t._id}')">Delete</button>
                        </div>`;
                    (t.status === 'pending' ? p : a).appendChild(div);
                });
            };
            window.approveTest = async id => { await fetch('/api/testimonials/approve/' + id, { method: 'PUT', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ password: adminPassword }) }); loadTestimonials(); };
            window.deleteTest = async id => { if (confirm('Delete?')) { await fetch('/api/testimonials/' + id, { method: 'DELETE', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ password: adminPassword }) }); loadTestimonials(); } };

            document.getElementById('testimonial-form').onsubmit = async e => {
                e.preventDefault();
                await fetch('/api/testimonials/admin', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ author: document.getElementById('testimonial-author').value, quote: document.getElementById('testimonial-quote').value, password: adminPassword }) });
                showToast('Testimonial Added!', 'success'); loadTestimonials(); e.target.reset();
            };

            /* --- SITE SETTINGS --- */
            async function loadSiteSettings() {
                const r = await fetch('/api/settings');
                const d = await r.json();
                settingsCache = d || {};
                document.getElementById('set-logo-url').value = d.logoUrl || '';
                document.getElementById('set-about-img-url').value = d.aboutImageUrl || '';
                document.getElementById('set-about-text').value = d.aboutText || '';
                document.getElementById('set-personal-link').value = d.personalLink || '';
                document.getElementById('set-personal-link-logo').value = d.personalLinkLogo || '';
                renderAdhyayTotalsGrid(d.adhyayTotals || {});
                renderCourseStatusOverrides();
                if (d.social) {
                    document.getElementById('soc-instagram').value = d.social.instagram || '';
                    document.getElementById('soc-youtube').value = d.social.youtube || '';
                    document.getElementById('soc-twitter').value = d.social.twitter || '';
                    document.getElementById('soc-facebook').value = d.social.facebook || '';
                }
            }

            document.getElementById('settings-form').onsubmit = async e => {
                e.preventDefault();
                const adhyayTotals = {};
                for (let i = 1; i <= 18; i++) {
                    const val = parseInt(document.getElementById(`adhyay-total-${i}`)?.value, 10);
                    if (Number.isFinite(val) && val > 0) adhyayTotals[i] = val;
                }

                const courseStatusOverrides = {};
                document.querySelectorAll('#course-status-list select').forEach(sel => {
                    const id = sel.dataset.courseId;
                    if (sel.value) courseStatusOverrides[id] = sel.value;
                });
                const data = {
                    logoUrl: document.getElementById('set-logo-url').value,
                    aboutImageUrl: document.getElementById('set-about-img-url').value,
                    aboutText: document.getElementById('set-about-text').value,
                    personalLink: document.getElementById('set-personal-link').value,
                    personalLinkLogo: document.getElementById('set-personal-link-logo').value,
                    social: {
                        instagram: document.getElementById('soc-instagram').value,
                        youtube: document.getElementById('soc-youtube').value,
                        twitter: document.getElementById('soc-twitter').value,
                        facebook: document.getElementById('soc-facebook').value
                    },
                    adhyayTotals,
                    courseStatusOverrides,
                    password: adminPassword
                };
                const r = await fetch('/api/settings', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(data) });
                if (r.ok) showToast('Settings Updated!', 'success');
            };

            /* --- STUDENTS --- */
            async function loadStudents() {
                const r = await fetch(`/api/admin/detailed-students?password=${adminPassword}`);
                const list = await r.json();
                const box = document.getElementById('student-list');
                box.innerHTML = '';
                list.forEach(s => {
                    const div = document.createElement('div');
                    div.className = 'shloka-admin-item';
                    div.innerHTML = `
                        <div>
                            <strong>${s.name}</strong> (${s.mobile})<br>
                            <small>Enrolled: ${s.coursesEnrolled} | Passed: ${s.quizzesPassed}</small>
                        </div>
                        <div>Last Active: ${new Date(s.lastActive).toLocaleDateString()}</div>
                    `;
                    box.appendChild(div);
                });
            }

            document.getElementById('push-form').onsubmit = async e => {
                e.preventDefault();
                const r = await fetch('/api/push/send', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        title: document.getElementById('push-title').value,
                        body: document.getElementById('push-body').value,
                        url: document.getElementById('push-url').value,
                        password: adminPassword
                    })
                });
                if (r.ok) {
                    let d = await r.json();
                    const parts = [];
                    if (d.sent) parts.push(`sent ${d.sent}`);
                    if (d.failed) parts.push(`${d.failed} failed`);
                    if (d.removed) parts.push(`${d.removed} removed`);
                    showToast(`Broadcast ${parts.join(', ') || 'done'}.`, d.failed ? 'error' : 'success');
                    e.target.reset();
                }
            };

            /* --- INIT --- */
            async function loadAdhyayForCourses() {
                const r = await fetch('/api/shlokas'); const sh = await r.json();
                const ads = [...new Set(sh.map(s => s.adhyay))].sort((a, b) => a - b);
                const sel = document.getElementById('course-adhyay');
                sel.innerHTML = '<option value="">Select Adhyay</option>';
                ads.forEach(a => sel.innerHTML += `<option value="${a}">Adhyay ${a}</option>`);
            }
            document.getElementById('course-adhyay').onchange = async e => {
                const r = await fetch('/api/shlokas'); const sh = await r.json();
                document.getElementById('course-shloka-list').innerHTML = sh.filter(s => s.adhyay == e.target.value).map(s => `<label style="display:block; margin:5px 0;"><input type="checkbox" value="${s._id}"> Shloka ${s.shloka}</label>`).join('');
            };
            async function loadCoursesForQuiz() {
                const r = await fetch('/api/courses'); const list = await r.json();
                const sel = document.getElementById('quiz-course');
                sel.innerHTML = '<option value="">Select Course</option>';
                list.forEach(c => sel.innerHTML += `<option value="${c._id}">${c.title}</option>`);
            }
            // --- Detailed Student Management ---
            async function loadStudentsV2() {
                const r = await fetch(`/api/admin/detailed-students?password=${adminPassword}`);
                const list = await r.json();
                studentsDetailedCache = Array.isArray(list) ? list : [];
                const box = document.getElementById('student-list');
                box.innerHTML = '';
                if (!list.length) {
                    box.innerHTML = '<div style="color:var(--text-muted);">No students registered yet.</div>';
                    return;
                }
                list.forEach(s => {
                    const div = document.createElement('div');
                    div.className = 'shloka-admin-item';
                    div.style.cursor = 'pointer';
                    div.onclick = (e) => {
                        if (e.target.tagName !== 'BUTTON') viewStudentDetails(s);
                    };
                    div.innerHTML = `
                        <div style="flex:1;">
                            <strong>${s.name}</strong> 
                            <span style="font-size:0.9rem; color:var(--text-muted); margin-left:10px;">${s.mobile}</span><br>
                            <small style="color:var(--text-muted);">
                                Enrolled: ${s.enrolledCourses?.length || 0} | Passed: ${s.passedCourses?.length || 0}
                            </small>
                            <br>
                            <small style="color:var(--text-muted);">
                                Daily Limit: ${s.daily_limit || 3} | Used Today: ${s.used_today || 0}
                            </small>
                        </div>
                        <div class="admin-buttons">
                            <button class="edit-button" onclick='viewStudentDetails(${JSON.stringify(s).replace(/'/g, "&#39;")})'>
                                <i class="fas fa-eye"></i> View Details
                            </button>
                            <button class="edit-button" onclick="updateStudentLimit('${s._id}', ${s.daily_limit || 3})">
                                Set Limit
                            </button>
                            <button class="edit-button" onclick="resetStudentLimit('${s._id}')">
                                Reset Today
                            </button>
                            <button class="delete-button" onclick="deleteStudent('${s._id}')">Delete</button>
                        </div>
                    `;
                    box.appendChild(div);
                });
                loadCertificateFormStudents();
            }

            function makeCourseCode(title) {
                return String(title || 'GEN')
                    .toUpperCase()
                    .replace(/[^A-Z0-9]+/g, '-')
                    .replace(/^-+|-+$/g, '')
                    .slice(0, 8) || 'GEN';
            }
            function makeStudentCode(mobile) {
                const m = String(mobile || '');
                return m.slice(-4) || '0000';
            }
            function makeCertificateId(courseTitle, mobile) {
                const year = new Date().getFullYear();
                return `GS-${makeCourseCode(courseTitle)}-${makeStudentCode(mobile)}-${year}`;
            }
            function loadCertificateFormStudents() {
                const studentSel = document.getElementById('mc-student');
                if (!studentSel) return;
                studentSel.innerHTML = '<option value="">Select Student</option>';
                studentsDetailedCache.forEach((s) => {
                    studentSel.innerHTML += `<option value="${s._id}">${s.name} (${s.mobile})</option>`;
                });
            }
            function loadCertificateCoursesForStudent(studentId) {
                const courseSel = document.getElementById('mc-course');
                const certIdInput = document.getElementById('mc-cert-id');
                if (!courseSel) return;
                courseSel.innerHTML = '<option value="">Select Enrolled Course</option>';
                certIdInput.value = '';
                const student = studentsDetailedCache.find((s) => s._id === studentId);
                if (!student) return;

                const allCourses = [...(student.enrolledCourses || []), ...(student.passedCourses || [])];
                const uniqueByTitle = [];
                const seen = new Set();
                allCourses.forEach((c) => {
                    const title = c.courseTitle;
                    if (!title || seen.has(title)) return;
                    seen.add(title);
                    uniqueByTitle.push(c);
                });
                uniqueByTitle.forEach((c) => {
                    courseSel.innerHTML += `<option value="${c.courseTitle}">${c.courseTitle}</option>`;
                });
            }

            window.viewStudentDetails = (s) => {
                let enrolledHtml = '<div style="margin-top:15px; border-top:1px solid #eee; padding-top:10px;"><h4>📚 Enrolled Courses</h4>';
                if (s.enrolledCourses && s.enrolledCourses.length > 0) {
                    s.enrolledCourses.forEach(c => {
                        const completed = c.completedShlokas || 0;
                        const total = c.totalShlokas || 0;
                        const percentage = total > 0 ? Math.round((completed / total) * 100) : 0;
                        enrolledHtml += `
                            <div style="background:#f8f9fa; padding:10px; margin:8px 0; border-radius:6px; border-left:3px solid #ff9800;">
                                <strong>${c.courseTitle}</strong><br>
                                <small>Progress: ${completed}/${total} shlokas (${percentage}%)</small>
                                <div style="background:#e0e0e0; height:6px; border-radius:3px; margin-top:5px; overflow:hidden;">
                                    <div style="background:#ff9800; height:100%; width:${percentage}%;"></div>
                                </div>
                            </div>
                        `;
                    });
                } else {
                    enrolledHtml += '<p style="color:var(--text-muted); font-size:0.9rem;">No courses enrolled yet.</p>';
                }
                enrolledHtml += '</div>';

                let passedHtml = '<div style="margin-top:15px; border-top:1px solid #eee; padding-top:10px;"><h4>✅ Passed Courses</h4>';
                if (s.passedCourses && s.passedCourses.length > 0) {
                    s.passedCourses.forEach(c => {
                        const score = c.quizScore || 0;
                        passedHtml += `
                            <div style="background:#e8f5e9; padding:10px; margin:8px 0; border-radius:6px; border-left:3px solid #4caf50;">
                                <strong>${c.courseTitle}</strong><br>
                                <small>Quiz Score: ${score}% ✓</small>
                            </div>
                        `;
                    });
                } else {
                    passedHtml += '<p style="color:var(--text-muted); font-size:0.9rem;">No courses passed yet.</p>';
                }
                passedHtml += '</div>';

                const html = `
                    <div style="max-height:500px; overflow-y:auto;">
                        <div style="margin-bottom:15px;">
                            <strong>Name:</strong> ${s.name}<br>
                            <strong>Mobile:</strong> ${s.mobile}<br>
                            <strong>Daily Limit:</strong> ${s.daily_limit || 3}<br>
                            <strong>Used Today:</strong> ${s.used_today || 0}
                        </div>
                        ${enrolledHtml}
                        ${passedHtml}
                        <div style="display:flex; gap:10px; margin-top:20px; padding-top:15px; border-top:1px solid #eee;">
                            <button onclick="editStudentDetails('${s._id}', '${s.name}', '${s.mobile}')" class="primary-btn" style="flex:1;">
                                <i class="fas fa-edit"></i> Edit Details
                            </button>
                            <button onclick="deleteStudent('${s._id}')" style="background:#ef4444; color:white; border:none; border-radius:8px; flex:1; cursor:pointer; padding:10px;">
                                <i class="fas fa-trash"></i> Delete Student
                            </button>
                        </div>
                    </div>
                `;

                openEditModal('Student Profile: ' + s.name, html);
            };

            window.editStudentDetails = (id, currentName, currentMobile) => {
                const html = `
                    <form id="student-update-form">
                        <label style="font-weight:600; margin-bottom:5px; display:block;">Full Name</label>
                        <input id="stu-name" value="${currentName}" placeholder="Full Name" required>
                        
                        <label style="font-weight:600; margin-bottom:5px; display:block; margin-top:15px;">Mobile Number</label>
                        <input id="stu-mobile" value="${currentMobile}" placeholder="Mobile Number" required>
                        
                        <label style="font-weight:600; margin-bottom:5px; display:block; margin-top:15px;">New Password (leave blank to keep current)</label>
                        <input type="password" id="stu-password" placeholder="New Password (optional)">
                        
                        <button type="submit" class="primary-btn" style="margin-top:20px;">Update Details</button>
                    </form>
                `;

                openEditModal('Edit Student Details', html);

                document.getElementById('student-update-form').onsubmit = async (e) => {
                    e.preventDefault();

                    const updateData = {
                        name: document.getElementById('stu-name').value,
                        mobile: document.getElementById('stu-mobile').value,
                        adminPassword: adminPassword
                    };

                    const newPassword = document.getElementById('stu-password').value;
                    if (newPassword && newPassword.trim()) {
                        updateData.password = newPassword.trim();
                    }

                    const res = await fetch(`/api/admin/student/${id}`, {
                        method: 'PUT',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(updateData)
                    });

                    if (res.ok) {
                        showToast('Student Updated!', 'success');
                        closeEditModal();
                        loadStudentsV2();
                    } else {
                        const error = await res.json();
                        showToast(error.message || 'Update failed!', 'error');
                    }
                };
            };

            window.deleteStudent = async (id) => {
                if (confirm('Delete this student? This will remove their account and all progress.')) {
                    const res = await fetch(`/api/admin/student/${id}`, {
                        method: 'DELETE',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ password: adminPassword })
                    });
                    if (res.ok) {
                        showToast('Student Deleted!', 'success');
                        closeEditModal();
                        loadStudentsV2();
                    } else {
                        showToast('Delete failed!', 'error');
                    }
                }
            };

            window.updateStudentLimit = async (studentId, currentLimit) => {
                const value = prompt('Enter new daily limit:', String(currentLimit || 3));
                if (!value) return;
                const limit = Number(value);
                if (!Number.isInteger(limit) || limit <= 0) {
                    return showToast('Invalid limit', 'error');
                }
                const res = await fetch('/api/admin-update-limit', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        adminPassword,
                        userId: studentId,
                        new_limit: limit
                    })
                });
                if (res.ok) {
                    showToast('Daily limit updated', 'success');
                    loadStudentsV2();
                } else {
                    const err = await res.json();
                    showToast(err.message || 'Failed to update limit', 'error');
                }
            };

            window.resetStudentLimit = async (studentId) => {
                const res = await fetch('/api/reset-daily-limit', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ password: adminPassword, userId: studentId })
                });
                if (res.ok) {
                    showToast('Today usage reset', 'success');
                    loadStudentsV2();
                } else {
                    showToast('Reset failed', 'error');
                }
            };

            async function loadAnalytics() {
                const res = await fetch(`/api/analytics?password=${adminPassword}`);
                if (!res.ok) return;
                const data = await res.json();

                const sBox = document.getElementById('analytics-student');
                const shBox = document.getElementById('analytics-shlok');
                const cBox = document.getElementById('analytics-course');
                const oBox = document.getElementById('analytics-overview');
                const searchInput = document.getElementById('analytics-search');
                const sortInput = document.getElementById('analytics-sort');
                if (!sBox || !shBox || !cBox || !oBox) return;

                const overview = data.overview || {};
                oBox.innerHTML = `
                    <div class="stat-card"><h3>Total Students</h3><span class="stat-number">${overview.total_students || 0}</span></div>
                    <div class="stat-card"><h3>Active Today</h3><span class="stat-number">${overview.active_today || 0}</span></div>
                    <div class="stat-card"><h3>AI Usage Today</h3><span class="stat-number">${overview.ai_usage_today || 0}</span></div>
                    <div class="stat-card"><h3>Total Courses</h3><span class="stat-number">${overview.total_courses || 0}</span></div>
                `;

                const allStudents = Array.isArray(data.student_usage) ? data.student_usage : [];
                function renderStudentTable() {
                    const q = (searchInput.value || '').trim().toLowerCase();
                    const key = sortInput.value || 'ai_used_today';
                    const filtered = allStudents
                        .filter((s) => !q || String(s.name || '').toLowerCase().includes(q))
                        .sort((a, b) => Number(b[key] || 0) - Number(a[key] || 0));
                    sBox.innerHTML = `
                        <table style="width:100%; border-collapse:collapse;">
                            <thead><tr><th align="left">Student Name</th><th align="left">AI Used Today</th><th align="left">Daily Limit</th><th align="left">Shlok Views</th><th align="left">Course Completion %</th></tr></thead>
                            <tbody>
                                ${filtered.map((s) => `
                                    <tr style="border-top:1px solid #eee;">
                                        <td style="padding:8px 0;">${s.name || '-'}</td>
                                        <td>${s.ai_used_today || 0}</td>
                                        <td>${s.daily_limit || 3}</td>
                                        <td>${s.shlok_views || 0}</td>
                                        <td>${s.course_completion_percent || 0}%</td>
                                    </tr>`).join('')}
                            </tbody>
                        </table>
                    `;
                }
                renderStudentTable();
                searchInput.oninput = renderStudentTable;
                sortInput.onchange = renderStudentTable;

                const shlokRows = Array.isArray(data.shlok_analytics) ? data.shlok_analytics : [];
                const topView = shlokRows.length ? Math.max(...shlokRows.map((s) => Number(s.views || 0))) : 0;
                shBox.innerHTML = `
                    <table style="width:100%; border-collapse:collapse;">
                        <thead><tr><th align="left">Adhyay</th><th align="left">Shlok</th><th align="left">Views</th><th align="left">Listens</th></tr></thead>
                        <tbody>
                            ${shlokRows.slice(0, 30).map((s) => `
                                <tr style="border-top:1px solid #eee; ${Number(s.views || 0) === topView && topView > 0 ? 'background:#fff7ed;' : ''}">
                                    <td style="padding:8px 0;">${s.adhyay}</td>
                                    <td>${s.shlok}</td>
                                    <td>${s.views}</td>
                                    <td>${s.listens}</td>
                                </tr>`).join('')}
                        </tbody>
                    </table>
                `;

                const courseRows = Array.isArray(data.course_analytics) ? data.course_analytics : [];
                cBox.innerHTML = `
                    <table style="width:100%; border-collapse:collapse;">
                        <thead><tr><th align="left">Course Name</th><th align="left">Enrolled Count</th><th align="left">Completed Count</th><th align="left">Avg Progress %</th></tr></thead>
                        <tbody>
                            ${courseRows.map((c) => `
                                <tr style="border-top:1px solid #eee;">
                                    <td style="padding:8px 0;">${c.course_name}</td>
                                    <td>${c.enrolled_count}</td>
                                    <td>${c.completed_count}</td>
                                    <td>${c.avg_progress_percent}%</td>
                                </tr>`).join('')}
                        </tbody>
                    </table>
                `;
            }
        });
    </script>
  <script src="/geeta-saarathi.js"></script>
</body>

</html>



