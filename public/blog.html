<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gitadhya - Blogs</title>
    <link rel="icon" href="/favicon.ico" sizes="any">
    <link rel="icon" type="image/png" href="/favicon.png">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;600;700;900&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="style.css">
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-messaging-compat.js"></script>
    <link rel="manifest" href="/site.webmanifest">
</head>

<body>

    <nav class="top-navbar">
        <div class="container nav-container">
            <div class="logo">
                <a href="index.html">Gitadhya</a>
            </div>
            <div class="menu-links" id="nav-links">
                <a href="index.html" class="main-tab-button">Home</a>
                <a href="index.html#site-about-main" class="main-tab-button">About</a>
                <a href="courses.html" class="main-tab-button">Courses</a>
                <a href="artwork.html" class="main-tab-button">Art</a>
                <a href="blog.html" class="main-tab-button active">Blog</a>
                <a href="testimonials.html" class="main-tab-button">Testimonials</a>
                <button class="main-tab-button" id="back-btn" onclick="goBack()"
                    style="display:none; background:#eee; border-radius: 10px;">
                    <i class="fas fa-arrow-left"></i> All Courses
                </button>
                <div id="auth-box">
                    <a href="index.html?auth=true" class="main-tab-button">Login</a>
                </div>
            </div>
            <button class="menu-toggle" id="menu-btn"><i class="fas fa-bars"></i></button>
        </div>
    </nav>

    <div class="container" style="padding: 40px 20px;">
        <h1 id="page-title" style="text-align: center; margin-bottom: 40px; color: var(--primary-dark);">Blogs
        </h1>
        <main id="blog-list-container" class="card-grid">
            <p style="grid-column: 1/-1; text-align:center;">Loading blogs...</p>
        </main>
        <main id="single-blog-container" style="display:none;">
            <p>Loading blog post...</p>
        </main>
    </div>

    <footer class="main-footer">
        <div class="container">
            <h2 id="footer-logo-text">Gitadhya</h2>
            <div class="social-row" id="social-links"></div>
            <p style="opacity: 0.6; font-size: 0.9rem;">&copy; 2026 Gitadhya | Gita by Aaradhya</p>
        </div>
    </footer>

    <script>
        // Single blog post card banane ka function
        function createSingleBlogCard(post) {
            const item = document.createElement('article');
            item.className = 'blog-post-item'; // Puraana style reuse karein

            const postDate = new Date(post.createdAt).toLocaleDateString('en-IN', {
                day: 'numeric', month: 'long', year: 'numeric'
            });

            const isLiked = localStorage.getItem('liked_blog_' + post._id) === 'true';

            // Share data
            const shareTitle = post.title + " - by Gitadhya";
            const shareText = "Check out this blog post from Gitadhya!";
            const shareUrl = window.location.href;

            item.innerHTML = `
    <h3>${post.title}</h3>
    <p class="blog-date">${postDate}</p>

    ${post.imageUrl ? `
        <img src="${post.imageUrl}"
             class="blog-image"
             alt="${post.title}">
    ` : ''}

    <div class="blog-content">
        ${post.content.replace(/\n/g, '<br>')}
    </div>
                <div class="shloka-actions">
                    <button class="shloka-action-button like-button" data-id="${post._id}" ${isLiked ? 'disabled' : ''}>
                        ‚ù§Ô∏è <span class="like-count">${post.likes || 0}</span>
                    </button>
                    <button class="shloka-action-button share-button" 
                            data-url="${shareUrl}" 
                            data-title="${shareTitle}" 
                            data-text="${shareText}">
                        üîó Share
                    </button>
                </div>
            `;
            return item;
        }

        // Blog list card
        function createBlogListCard(post) {
            const item = document.createElement('article');
            item.className = 'blog-card';

            const postDate = new Date(post.createdAt).toLocaleDateString('en-IN', {
                day: 'numeric', month: 'long', year: 'numeric'
            });

            const isLiked = localStorage.getItem('liked_blog_' + post._id) === 'true';
            const excerpt = (post.content || '').replace(/\n/g, ' ').slice(0, 160);
            const shareUrl = `${window.location.origin}/blog.html?id=${post._id}`;
            const shareTitle = post.title + " - by Gitadhya";
            const shareText = "Check out this blog post from Gitadhya!";

            item.innerHTML = `
                <h3>${post.title}</h3>
                <div class="blog-date">${postDate}</div>
                ${post.imageUrl ? `<img src="${post.imageUrl}" class="blog-image" alt="${post.title}">` : ''}
                <p>${excerpt}${excerpt.length >= 160 ? '...' : ''}</p>
                <div style="font-weight:700; color:var(--primary); cursor:pointer;" onclick="location.href='blog.html?id=${post._id}'">
                    Read Wisdom <i class="fas fa-arrow-right"></i>
                </div>
                <div class="blog-card-actions">
                    <button class="shloka-action-button like-button" data-id="${post._id}" ${isLiked ? 'disabled' : ''}>
                        ‚ù§Ô∏è <span class="like-count">${post.likes || 0}</span>
                    </button>
                    <button class="shloka-action-button share-button"
                            data-url="${shareUrl}"
                            data-title="${shareTitle}"
                            data-text="${shareText}">
                        üîó Share
                    </button>
                </div>
            `;
            return item;
        }

        // Page load hone par post fetch karo
        document.addEventListener('DOMContentLoaded', async () => {
            const pageTitle = document.getElementById('page-title');
            const listContainer = document.getElementById('blog-list-container');
            const singleContainer = document.getElementById('single-blog-container');
            const params = new URLSearchParams(window.location.search);
            const postId = params.get('id');

            try {
                // Load site info for social links
                try {
                    const sr = await fetch('/api/settings');
                    const settings = await sr.json();
                    const socBox = document.getElementById('social-links');
                    if (socBox) {
                        socBox.innerHTML = '';
                        const icons = { instagram: 'fab fa-instagram', youtube: 'fab fa-youtube', twitter: 'fab fa-twitter', facebook: 'fab fa-facebook' };
                        if (settings.personalLink) {
                            if (settings.personalLinkLogo) {
                                socBox.innerHTML += `<a href="${settings.personalLink}" target="_blank" class="social-icon"><img src="${settings.personalLinkLogo}" style="height:24px; width:24px; border-radius:50%; vertical-align:middle;"></a>`;
                            } else {
                                socBox.innerHTML += `<a href="${settings.personalLink}" target="_blank" class="social-icon"><i class="fas fa-globe"></i></a>`;
                            }
                        }
                        if (settings.social) {
                            Object.keys(settings.social).forEach(key => {
                                const url = settings.social[key];
                                if (url) socBox.innerHTML += `<a href="${url}" target="_blank" class="social-icon"><i class="${icons[key]}"></i></a>`;
                            });
                        }
                    }
                } catch (e) { console.error("Settings load error", e); }

                if (postId) {
                    const cacheBuster = `?cache_buster=${new Date().getTime()}`;
                    const response = await fetch(`/api/blog/${postId}${cacheBuster}`);
                    if (!response.ok) {
                        const errorData = await response.json();
                        throw new Error(errorData.message || 'Blog post not found');
                    }
                    const post = await response.json();
                    pageTitle.innerText = post.title;
                    listContainer.style.display = 'none';
                    singleContainer.style.display = 'block';
                    singleContainer.innerHTML = '';
                    const blogCard = createSingleBlogCard(post);
                    singleContainer.appendChild(blogCard);
                } else {
                    pageTitle.innerText = 'Blogs';
                    listContainer.style.display = 'grid';
                    singleContainer.style.display = 'none';
                    const response = await fetch('/api/blog');
                    const posts = await response.json();
                    listContainer.innerHTML = '';
                    if (!posts || posts.length === 0) {
                        listContainer.innerHTML = '<p style="grid-column: 1/-1; text-align:center;">No blogs found yet.</p>';
                    } else {
                        posts.forEach(p => listContainer.appendChild(createBlogListCard(p)));
                    }
                }

                // --- Mobile Menu ---
                const menuBtn = document.getElementById('menu-btn');
                const navLinks = document.getElementById('nav-links');
                if (menuBtn && navLinks) {
                    menuBtn.onclick = () => {
                        navLinks.classList.toggle('active');
                    };
                }
            } catch (err) {
                singleContainer.style.display = 'block';
                listContainer.style.display = 'none';
                singleContainer.innerHTML = '<p>Blog load error.</p>';
            }

            // --- [NAYA FIX] ---
            // Click listener ko DOMContentLoaded ke ANDAR yahaan move kar diya hai
            // Taaki yeh content load hone ke BAAD attach ho
            document.addEventListener('click', async (e) => {
                const shareButton = e.target.closest('.share-button');
                if (shareButton) {
                    const urlToShare = shareButton.dataset.url;
                    const title = shareButton.dataset.title;
                    const text = shareButton.dataset.text;
                    if (navigator.share) {
                        try { await navigator.share({ title: title, text: text, url: urlToShare }); }
                        catch (err) { console.error('Share failed:', err); }
                    } else {
                        try { await navigator.clipboard.writeText(urlToShare); alert('Link copied to clipboard!'); }
                        catch (err) { alert('Failed to copy link.'); }
                    }
                }

                const likeButton = e.target.closest('.like-button');
                if (likeButton) {
                    const postId = likeButton.dataset.id;
                    const key = 'liked_blog_' + postId;
                    if (localStorage.getItem(key)) { return; }

                    likeButton.disabled = true;
                    try {
                        const response = await fetch(`/api/blog/like/${postId}`, { method: 'POST' });
                        const data = await response.json();
                        if (data.success) {
                            likeButton.querySelector('.like-count').textContent = data.likes;
                            localStorage.setItem(key, 'true');
                        } else {
                            likeButton.disabled = false;
                        }
                    } catch (err) {
                        likeButton.disabled = false;
                    }
                }
            });
            // --- FIX END ---
        });

    </script>
    <script src="pwa.js"></script>
</body>

</html>